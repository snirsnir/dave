<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注 转转  注 Three.js</title>
    <!-- 注转 住驻专转 Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/FirstPersonControls.js"></script>
    <!-- 注转 住驻专转 Audio -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            cursor: default;
        }
        
        #scene-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
        
        #interaction-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            display: none;
            z-index: 100;
        }
        
        #interaction-button:hover {
            background-color: #45a049;
        }
        
        #controls-info {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        
        #next-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        
        #back-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            pointer-events: none;
            z-index: 100;
        }
        #music-toggle {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    border-radius: 5px;
    padding: 5px 10px;
    font-size: 20px;
    cursor: pointer;
    z-index: 100;
}

#music-toggle:hover {
    background-color: rgba(0, 0, 0, 0.7);
}
/* Modal Styles */
/* Modal Styles - 转专  爪注  */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    font-family: 'Varela Round', Arial, sans-serif;
}

.modal-content {
    position: relative;
    background-color: #f8f8f8;
    background-image: linear-gradient(to bottom, #e6f7ff, #ffffff);
    margin: 5% auto;
    width: 90%;
    max-width: 700px;
    border-radius: 25px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    animation: modalPopIn 0.7s;
    direction: rtl;
    border: 8px solid #4CAF50;
}

@keyframes modalPopIn {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.05); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
}

.modal-header {
    background: linear-gradient(to left, #4CAF50, #2E8B57);
    color: white;
    padding: 20px;
    border-radius: 17px 17px 0 0;
    display: flex;
    justify-content: center; /* 砖 -space-between -center */
    align-items: center;
    position: relative; /* 住驻 position relative */
}

.modal-header h2 {
    margin: 0;
    font-size: 32px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    font-weight: bold;
}

.close-modal {
    color: white;
    font-size: 36px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.3s;
    position: absolute; /* 拽  */
    left: 20px; /* 拽 爪 砖 砖 转专转 */
    top: 50%; /* 专  */
    transform: translateY(-50%); /* 专  拽 */
}

.close-modal:hover {
    color: #ffcc00;
    transform: translateY(-50%) rotate(90deg);
}

.modal-body {
    padding: 30px;
    background-color: white;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="%234CAF50" opacity="0.1"/></svg>');
}

.instruction {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    background-color: #f9f9f9;
    padding: 15px;
    border-radius: 15px;
    border-right: 8px solid #4CAF50;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.3s;
}

.instruction:hover {
    background-color: #f0f8ff;
    transform: translateX(-10px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.icon {
    font-size: 36px;
    margin-left: 20px;
    min-width: 50px;
    text-align: center;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.text {
    font-size: 22px;
    font-weight: bold;
    color: #333;
}

.modal-footer {
    padding: 25px;
    text-align: center;
    background-color: #f0f0f0;
    border-radius: 0 0 17px 17px;
    background: linear-gradient(to bottom, #ffffff, #e6f7ff);
}

#start-game {
    background: linear-gradient(to bottom, #4CAF50, #3e8e41);
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 24px;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    transition: all 0.3s;
    font-weight: bold;
    letter-spacing: 1px;
}


#start-game:hover {
    background: linear-gradient(to bottom, #3e8e41, #2e6b31);
    transform: scale(1.1);
    box-shadow: 0 8px 16px rgba(0,0,0,0.3);
}

/* 住专转 爪爪转 转专转 */
.modal-title-container {
    position: relative;
    display: inline-block;
}

.modal-title-container h2 {
    position: relative;
    z-index: 1;
}

.modal-title-container::before {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border-radius: 10px;
    background: linear-gradient(45deg, 
        #ff0000, #ff7300, #fffb00, #48ff00, 
        #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
    background-size: 400%;
    z-index: 0;
    filter: blur(5px);
    opacity: 0;
    transition: opacity 0.3s;
}

.modal-header:hover .modal-title-container::before {
    opacity: 1;
    animation: glowing 20s linear infinite;
}
.adventure-button {
    background: linear-gradient(to bottom, #FF5722, #E64A19) !important;
    color: white !important;
    border: none !important;
    padding: 12px 25px !important;
    font-size: 20px !important;
    border-radius: 50px !important;
    cursor: pointer !important;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
    transition: all 0.3s !important;
    font-weight: bold !important;
    margin-top: 10px !important;
    display: inline-block !important;
}

.adventure-button:hover {
    background: linear-gradient(to bottom, #E64A19, #D84315) !important;
    transform: scale(1.05) !important;
    box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
}
@keyframes glowing {
    0% { background-position: 0 0; }
    50% { background-position: 400% 0; }
    100% { background-position: 0 0; }
}


.mission-container {
    background: linear-gradient(135deg, rgba(25, 25, 35, 0.85), rgba(40, 40, 70, 0.9));
    border: 2px solid #64DD17;
    border-radius: 15px;
    padding: 3px;
    box-shadow: 0 0 15px rgba(100, 221, 23, 0.6), 0 0 30px rgba(0, 0, 0, 0.4);
    position: relative;
    overflow: hidden;
}

.mission-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, 
        rgba(100, 221, 23, 0.2) 0%, 
        rgba(0, 0, 0, 0) 40%, 
        rgba(0, 0, 0, 0) 60%, 
        rgba(100, 221, 23, 0.2) 100%);
    z-index: -1;
}

.mission-content {
    background: rgba(20, 20, 30, 0.7);
    border-radius: 12px;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    position: relative;
    z-index: 1;
}

.mission-icon {
    font-size: 32px;
    margin-left: 15px;
    text-shadow: 0 0 10px #64DD17;
    animation: pulse-glow 2s infinite alternate;
}

.mission-text {
    text-align: right;
}

.mission-title {
    color: #64DD17;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
    text-shadow: 0 0 8px rgba(100, 221, 23, 0.8);
}

.mission-desc {
    color: white;
    font-size: 16px;
    font-weight: bold;
    text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
}

@keyframes pulse-glow {
    from { text-shadow: 0 0 10px #64DD17, 0 0 20px #64DD17; }
    to { text-shadow: 0 0 15px #64DD17, 0 0 30px #64DD17, 0 0 40px #64DD17; }
}

#mission-popup {
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0% { transform: translate(-50%, 0px); }
    50% { transform: translate(-50%, -10px); }
    100% { transform: translate(-50%, 0px); }
}
#video-modal .modal-content {
    max-width: 800px;
    background-color: #000;
    border: 8px solid #FF5722;
}

#video-modal .modal-header {
    background: linear-gradient(to left, #FF5722, #FF8A65);
}

#intro-video {
    display: block;
    border-radius: 0 0 17px 17px;
}
@keyframes blink {
    0%, 100% { border-color: transparent; }
    50% { border-color: white; }
}

.typewriter-cursor {
    display: inline-block;
    width: 3px;
    height: 0.9em;
    background-color: white;
    margin-right: 2px;
    margin-left: 2px;
    animation: blink 1s step-end infinite;
}
    </style>
</head>
<body>
<!-- Modal for video -->
<div id="video-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title-container">
                <h2>专  专驻转拽!</h2>
            </div>
        </div>
        <div class="modal-body" style="padding: 0;">
            <video id="intro-video" width="100%" controls>
                <source src="tutorial/1.mp4" type="video/mp4">
                驻驻 砖  转 转转 .
            </video>
        </div>
    </div>
</div>
<!--   专 拽注 驻 -->
<!--   专 拽注 驻 -->
<div id="tutorial-video-container" style="position: fixed; top: 10px; left: 10px; width: 332px; height: 250px; z-index: 2000; background-color: rgba(0,0,0,0.5); border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.5); display: none;">
    <video id="tutorial-video" width="100%" height="100%" style="object-fit: cover;">
        <source src="" type="video/mp4">
    </video>
</div>
    <div id="scene-container"></div>

    <button id="music-toggle" title="砖转拽/驻注 拽">
        
    </button>
    <div id="loading">注 转 注...</div>
    
    <div id="controls-info">
        <p>转注 拽: 拽砖 注 拽拽 砖 注专</p>
        <p>转注 专: 拽砖 注 拽拽  注专</p>
        <p>:  转 注专</p>
    </div>
    
    <div id="crosshair">+</div>
    
    <button id="interaction-button">抓  专拽爪</button>
    
    <div id="next-screen">
        <h1>注转 注!</h1>
        <p> 住 .</p>
        <button id="back-button">专 注</button>
    </div>
    <button id="music-toggle" title="砖转拽/驻注 拽">
    
</button>
<!-- Modal for navigation instructions -->
<!-- Modal for navigation instructions -->
<div id="typewriter-container" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; text-align: center; width: 90%; max-width: 800px;">
    <div id="typewriter-text" style="font-size: 36px; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); font-weight: bold; direction: rtl; background-color: rgba(0,0,0,0.6); padding: 20px; border-radius: 10px;"></div>
</div>
    <script>
        // 爪专转 住爪, 爪 专专专
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);


//  砖专 砖 爪 - 住祝
camera.rotation.x = THREE.MathUtils.degToRad(-20);  //  拽 驻 

const renderer = new THREE.WebGLRenderer({ antialias: true });
        camera.position.set(0, 0.3, 0);
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // 爪 专 转专
        
        // 专转 爪注 专拽注 砖 
        renderer.setClearColor(0x222222); // 驻专 专 转专 转拽专/拽专转
        document.getElementById('scene-container').appendChild(renderer.domElement);
        
        // 砖转 
// 砖转 
// 砖转 
// 砖转 
// 砖转 
// 砖转 
let controls;
let worldModel;
let customModels = [];
let treesWithColliders = [];
let isLoaded = false;
let clock = new THREE.Clock();
let ground;
let movementLocked = true;
let logoAudioPlayed = false; 
let leftLogoAudioPlayed = false; 
let topLogoAudioPlayed = false;
let bottomLogoAudioPlayed = false;
let playerHeightLogoAudioPlayed = false;
let walkingBackwardChecked = false; // 住驻转 砖转 
let previousPosition = null; // 砖专转 拽 拽
let backwardMovementTimer = 0; //  砖砖拽  专
let isPortalVisible = false;
let initialCameraQuaternion; // 砖专转   转转
// 砖转   专
let tutorialVideo = null;
let currentVideoClip = null;

        // 砖转 
        let walkSound;
        let isWalking = false;
        
        // 拽转 专拽爪
        const interactionPoint = new THREE.Vector3(5, 0, 5);
        const interactionRadius = 2;
        let isNearInteractionPoint = false;
        
        // 拽转 注专 转 住 
        const specialPortalPoint = new THREE.Vector3(-66.88, 2.28, 4.96);
        const portalRadius = 4; // 专住  转专 专 驻专
        let portalParticles; // 砖转 砖专转 注专转 拽拽 砖 驻专
        
        // 爪专转 驻专 注 拽拽 注砖 住
        const createPortalEffect = () => {
    // 爪专转 专 拽拽
    const particleCount = 500;
    const particleGeometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    
    // 专转 注砖 注 住 拽转 驻专
    for (let i = 0; i < particleCount; i++) {
        // 拽 拽专 转 住驻专
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * portalRadius;
        const height = Math.random() * 5; //  拽拽
        
        // 住驻转 专转 拽 拽
        positions[i * 3] = specialPortalPoint.x + Math.cos(angle) * radius;
        positions[i * 3 + 1] = specialPortalPoint.y + height;
        positions[i * 3 + 2] = specialPortalPoint.z + Math.sin(angle) * radius;
        
        // 爪注 住 注 专爪转 拽转
        colors[i * 3] = 0.5 + Math.random() * 0.2; // 
        colors[i * 3 + 1] = 0; // 专拽
        colors[i * 3 + 2] = 0.8 + Math.random() * 0.2; // 
    }
    
    particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    // 爪专转 专 拽拽 注 住 注专 (Blending) 转 注砖
    const particleMaterial = new THREE.PointsMaterial({
        size: 0.4,
        transparent: true,
        opacity: 0.6,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
        sizeAttenuation: true
    });
    
    // 爪专转 注专转 拽拽
    portalParticles = new THREE.Points(particleGeometry, particleMaterial);
    portalParticles.visible = false; // 驻专 住转专 转
    scene.add(portalParticles);
    
    // 住驻转 专 拽转 住 专 驻专
    const portalLight = new THREE.PointLight(0x9932CC, 1, 10);
    portalLight.position.copy(specialPortalPoint);
    portalLight.position.y += 1.5; // 专转 专 注
    portalLight.visible = false; // 专 住转专 转
    portalLight.name = 'portalLight'; // 转 砖  砖 爪 转 专 转专
    scene.add(portalLight);
};

        
        // 爪 驻专
        const animatePortal = () => {
            if (portalParticles) {
                const positions = portalParticles.geometry.attributes.position.array;
                
                for (let i = 0; i < positions.length; i += 3) {
                    // 转注 拽专转 拽
                    positions[i] += (Math.random() - 0.5) * 0.05;
                    positions[i + 1] += Math.random() * 0.05; // 转注 拽 注
                    positions[i + 2] += (Math.random() - 0.5) * 0.05;
                    
                    // 专 拽拽 砖爪 专 专 驻专
                    const dx = positions[i] - specialPortalPoint.x;
                    const dz = positions[i + 2] - specialPortalPoint.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance > portalRadius || positions[i + 1] > specialPortalPoint.y + 5) {
                        //  拽拽 爪 转, 专 转 拽 砖 转 驻专
                        const angle = Math.random() * Math.PI * 2;
                        const radius = Math.random() * portalRadius * 0.7;
                        
                        positions[i] = specialPortalPoint.x + Math.cos(angle) * radius;
                        positions[i + 1] = specialPortalPoint.y + Math.random() * 2.5;
                        positions[i + 2] = specialPortalPoint.z + Math.sin(angle) * radius;
                    }
                }
                
                portalParticles.geometry.attributes.position.needsUpdate = true;
            }
        };
        
        // 驻拽爪 拽转 拽 砖 注专 住 
        const checkCustomLocationPoints = (position) => {
    // 拽转 专拽 拽转 驻专 转
    const distanceToPortal = position.distanceTo(specialPortalPoint);
    
    // 专拽  驻专   砖拽 拽专 
    if (isPortalVisible && distanceToPortal < portalRadius / 2) {
        // 注专 祝 tunnel.html
        window.location.href = 'start.html';
        return true;
    }
    
    return false;
};
        // 拽注  砖拽 注 
        const PLAYER_HEIGHT = 1.7;
        
        // 转专 驻拽
        const setupLighting = () => {
    // 专 住 注爪 转-
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    
    // 专  注
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
    directionalLight.position.set(0, 20, 0);
    directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    //  专转 拽转 
    const createPointLight = (x, z) => {
        const light = new THREE.PointLight(0xffffff, 0.8, 40);
        light.position.set(x, 10, z);
        scene.add(light);
        return light;
    };
    
    // 住驻专 驻转 砖 专转
    createPointLight(0, 0);
    createPointLight(-30, -30);
    createPointLight(30, 30);
    createPointLight(-30, 30);
    createPointLight(30, -30);
    
    // 住专转 注专驻
    scene.fog = null;
};
        
        // 拽住专转 砖 爪转转
        const createRealisticGrassTexture = () => {
            const grassTextureSize = 1024;
            const canvas = document.createElement('canvas');
            canvas.width = grassTextureSize;
            canvas.height = grassTextureSize;
            const ctx = canvas.getContext('2d');
            
            // 专拽注 专拽 住住
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#2d4c15');
            gradient.addColorStop(0.3, '#3a5a21');
            gradient.addColorStop(0.6, '#3e6b1d');
            gradient.addColorStop(1, '#345c14');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 驻拽爪 爪专转 注 砖 专住
            const drawGrassStrand = (x, y, width, height, color) => {
                ctx.beginPath();
                
                // 转转 拽 住住 注
                ctx.moveTo(x, y + height);
                
                // 爪专转 注拽 注 拽专转 注 砖
                const cp1x = x - width/2 + Math.random() * width;
                const cp1y = y + height * 0.7;
                const cp2x = x - width/3 + Math.random() * width;
                const cp2y = y + height * 0.4;
                
                ctx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x, y);
                
                ctx.lineWidth = 1 + Math.random() * 1.5;
                ctx.strokeStyle = color;
                ctx.stroke();
            };
            
            // 爪专转 砖转 砖 注 砖  砖
            // 砖 1: 砖  转专 - 
            for (let i = 0; i < 5000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * 10; // 注 注专 住住
                const height = 15 + Math.random() * 30;
                const color = `hsl(${80 + Math.random() * 40}, ${60 + Math.random() * 30}%, ${20 + Math.random() * 10}%)`;
                
                drawGrassStrand(x, y, 2, height, color);
            }
            
            // 砖 2: 砖 专  - 专 转专
            for (let i = 0; i < 8000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * 15;
                const height = 10 + Math.random() * 20;
                const color = `hsl(${90 + Math.random() * 30}, ${70 + Math.random() * 20}%, ${30 + Math.random() * 15}%)`;
                
                drawGrassStrand(x, y, 1.5, height, color);
            }
            
            // 砖 3: 砖 拽爪专 - 专
            for (let i = 0; i < 10000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * 20;
                const height = 5 + Math.random() * 15;
                const color = `hsl(${100 + Math.random() * 20}, ${70 + Math.random() * 20}%, ${35 + Math.random() * 15}%)`;
                
                drawGrassStrand(x, y, 1, height, color);
            }
            
            // 住驻转 驻专 拽 驻专 拽专
            for (let i = 0; i < 500; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = 1 + Math.random() * 2;
                
                // 专 拽专转  爪  驻专 拽
                const flowerColors = ['#ffffff', '#ffffd0', '#ffff80', '#fbec5d'];
                ctx.fillStyle = flowerColors[Math.floor(Math.random() * flowerColors.length)];
                
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // 爪专转 拽住专 拽住
            const texture = new THREE.CanvasTexture(canvas);
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set(8, 8); // 专 专 转专 驻专 拽 转专
            
            return texture;
        };
        
        // 爪专转 驻转 专 住住转
        const createNormalMap = () => {
            const size = 512;
            const canvas = document.createElement('canvas');
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            
            //  注 爪注 专专转  砖 专 驻 -  (0,0,1)
            ctx.fillStyle = 'rgb(128, 128, 255)';
            ctx.fillRect(0, 0, size, size);
            
            // 爪专转 专拽 拽专 专 驻
            for (let i = 0; i < 5000; i++) {
                const x = Math.random() * size;
                const y = Math.random() * size;
                const radius = 1 + Math.random() * 3;
                
                // 爪专转 专爪 拽  专
                const r = 128 + Math.random() * 20 - 10;
                const g = 128 + Math.random() * 20 - 10;
                const b = 230 + Math.random() * 25;
                
                ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
                ctx.beginPath();
                ctx.arc(x, y, radius, 0, Math.PI * 2);
                ctx.fill();
            }
            
            const normalMap = new THREE.CanvasTexture(canvas);
            normalMap.wrapS = THREE.RepeatWrapping;
            normalMap.wrapT = THREE.RepeatWrapping;
            normalMap.repeat.set(8, 8);
            
            return normalMap;
        };
        
        // 爪专转 拽专拽注 注 注转
        const createGround = () => {
    const size = 200;
    const segments = 16; // 驻转转 住驻专 住    爪专 专 驻专
    const geometry = new THREE.PlaneGeometry(size, size, segments, segments);
    
    //  爪专 砖转 转  砖 砖   专爪 转 砖专
    
    // 爪专转 专 驻专 注 拽住专 砖 /转转
    const texture = createConcreteTexture();
    const groundMaterial = new THREE.MeshStandardMaterial({ 
    map: texture,
    roughness: 0.5, // 
    metalness: 0.2, // 注 转转
    side: THREE.DoubleSide,
    emissive: 0x111111, // 专 注爪 
    emissiveIntensity: 0.1 // 注爪 
});
    
    ground = new THREE.Mesh(geometry, groundMaterial);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);
    
    return ground;
};
const createConcreteTexture = () => {
    const textureSize = 1024;
    const canvas = document.createElement('canvas');
    canvas.width = textureSize;
    canvas.height = textureSize;
    const ctx = canvas.getContext('2d');
    
    // 爪注 专拽注 驻专 专 ( )
    ctx.fillStyle = '#b0b0b0'; // 驻专 专
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 专拽  砖 驻专
    for (let i = 0; i < 8000; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const size = Math.random() * 2 + 0.5;
        
        // 专拽  驻专 -  专  
        const shade = Math.floor(160 + Math.random() * 60); // 160-220
        ctx.fillStyle = `rgb(${shade}, ${shade}, ${shade})`;
        
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // 拽 专砖转 驻专
    const gridSize = 64;
    ctx.strokeStyle = '#999999'; // 驻专 
    ctx.lineWidth = 1.5;
    
    // 拽 驻拽
    for (let y = 0; y < canvas.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
    }
    
    // 拽 
    for (let x = 0; x < canvas.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
    }
    
    const texture = new THREE.CanvasTexture(canvas);
    texture.wrapS = THREE.RepeatWrapping;
    texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set(8, 8);
    
    return texture;
};
        // 驻拽爪 爪转   拽 住转
        const getGroundHeight = (x, z) => {
    return 0; // 砖 砖  0
};
        
        // 爪专转  注抓 爪转

const checkTreeCollisions = (newPosition) => {
    // 专住 砖拽
    const playerRadius = 0.5;
    
    for (const tree of treesWithColliders) {
        // 拽转 专拽 驻拽  (X,Z)
        const dx = newPosition.x - tree.position.x;
        const dz = newPosition.z - tree.position.z;
        const distance = Math.sqrt(dx * dx + dz * dz);
        
        //  专拽 拽 住 专住, 砖 转砖转
        if (distance < (playerRadius + tree.radius)) {
            return true; // 砖 转砖转
        }
    }
    
    return false; //  转砖转
};
        
        // 爪专转 注专 注爪 爪转

        // 爪专转 注专转 砖 祝 专砖
        const setupFirstPersonControls = () => {
    controls = new THREE.FirstPersonControls(camera, renderer.domElement);
    controls.movementSpeed = 4;
    controls.lookSpeed = 0.03;
    controls.lookVertical = true;
    controls.constrainVertical = true;
    controls.verticalMin = Math.PI / 6;
    controls.verticalMax = Math.PI / 1.8;
    
    // 拽注转 转 转转转 砖住转转 转专 
    controls.lon = 0;
    controls.lat = -60;  // 注专  -40, 注砖 转专 砖 = 转专 驻 
    controls.phi = Math.PI/2 - THREE.MathUtils.degToRad(-60);  //  转 注专 砖 lat
    controls.theta = THREE.MathUtils.degToRad(0);
    
    // 转 注 拽专转 砖转转
    controls.enabled = false;
    
    // 专 转 专 驻注 - 专拽 2% 拽爪转  "转"
    const boundaryThreshold = 0.02; // 拽 转专 = 转专 砖 驻注
    
    // 驻 转  注专
    document.addEventListener('mousemove', (e) => {
        //  转注 注 注 ,  注砖 
        if (!controls.enabled) return;
        
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;
        
        const isNearLeftEdge = mouseX < boundaryThreshold;
        const isNearRightEdge = mouseX > (1 - boundaryThreshold);
        const isNearTopEdge = mouseY < boundaryThreshold;
        const isNearBottomEdge = mouseY > (1 - boundaryThreshold);
        
        // 专拽  注专 砖 拽爪 住,  转 住转转
        if (isNearLeftEdge || isNearRightEdge || isNearTopEdge || isNearBottomEdge) {
            if (controls.activeLook !== false) {
                controls.activeLook = false;
            }
        } else {
            // 专转, 转 驻砖专 住转转,   转注 注
            if (controls.activeLook !== true) {
                controls.activeLook = true;
            }
        }
    });
    
    // 住驻转 驻转专 住祝: 砖专 注专 住 专 住
    document.addEventListener('mouseenter', () => {
        if (controls.enabled) {
            controls.activeLook = true;
        }
    });
};
        // 注转  GLB ( 拽)
        const loadGLB = (url = '3d/tutorial.glb', scale = 20, position = { x: 0, y: 8, z: 0 }, isCustom = false) => {
            const loader = new THREE.GLTFLoader();
            
            // 爪转 注转 注
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').textContent = '注 转 ...';
            
            loader.load(
                url,
                (gltf) => {
                    const model = gltf.scene;
                    
                    // 专转 爪  砖 
                    model.traverse((node) => {
                        if (node.isMesh) {
                            node.castShadow = true;
                            node.receiveShadow = true;
                            
                            // 驻 专     砖注 注- 砖转砖
                            if (!isCustom && node.geometry) {
                                node.geometry.scale(-1, 1, 1);
                                node.material.side = THREE.BackSide;
                            }
                        }
                    });
                    
                    // 住 拽 
                    model.scale.set(scale, scale, scale);
                    model.position.set(position.x, position.y, position.z);
                    
                    // 砖专转  砖转     拽专
                    if (!isCustom) {
                        worldModel = model;
                    } else {
                        // 住驻 注专  转 砖转
                        customModels.push(model);
                    }
                    
                    scene.add(model);
                    document.getElementById('loading').style.display = 'none';
                    isLoaded = true;
                    if (window.backgroundMusic && !window.backgroundMusic.playing()) {
    window.backgroundMusic.play();
    console.log('拽转 专拽注 驻注');
}
                },
                (xhr) => {
                    const percentComplete = (xhr.loaded / xhr.total) * 100;
                    document.getElementById('loading').textContent = 
                        `注 转 ... ${Math.round(percentComplete)}%`;
                },
                (error) => {
                    console.error('砖 注转 :', error);
                    document.getElementById('loading').style.display = 'none';
                    isLoaded = true;
                }
            );
        };
        
        // 拽  砖转砖 拽专 拽转 专拽爪
        const checkInteractionPoint = () => {
            const distance = camera.position.distanceTo(interactionPoint);
            
            if (distance < interactionRadius && !isNearInteractionPoint) {
                isNearInteractionPoint = true;
                document.getElementById('interaction-button').style.display = 'block';
            } 
            else if (distance >= interactionRadius && isNearInteractionPoint) {
                isNearInteractionPoint = false;
                document.getElementById('interaction-button').style.display = 'none';
            }
        };
        
        // 专拽爪 爪 注 驻转专
        document.getElementById('interaction-button').addEventListener('click', () => {
            document.getElementById('next-screen').style.display = 'flex';
            document.getElementById('interaction-button').style.display = 'none';
            controls.enabled = false; // 砖转转 砖 爪 住 
        });
        
        // 专 注
        document.getElementById('back-button').addEventListener('click', () => {
            document.getElementById('next-screen').style.display = 'none';
            controls.enabled = true; // 驻注转 砖 砖
        });
        
        // 转转  
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            if (controls) {
                controls.handleResize();
            }
        });
        
        // 专转 住 
        const setupWalkSound = () => {
    // 爪专转 拽 住  注 驻爪 驻注 专转 (loop)
    walkSound = new Howl({
        src: ['audio/walk.mp3'],
        loop: true,
        volume: 0.7
    });
    
    // 住驻转  专注 爪 注 驻转专 注专
    document.addEventListener('mousedown', (e) => {
        // 拽  抓 驻转专 砖 (0)   (2)   转注  注  拽专转 驻注转
        if ((e.button === 0 || e.button === 2) && !isWalking && !movementLocked && controls && controls.enabled) {
            walkSound.play();
            isWalking = true;
        }
    });
    
    // 住驻转  专注 砖专专 驻转专 注专
    document.addEventListener('mouseup', (e) => {
        // 拽  砖专专 驻转专 砖 (0)   (2)
        if ((e.button === 0 || e.button === 2) && isWalking) {
            walkSound.pause();
            isWalking = false;
        }
    });
    
    // 注转 转驻专 拽拽 
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
    });
};
        // 专转 注专转 砖注转 拽转 专拽注 专转
const setupBackgroundMusic = () => {
    // 注专 砖 转 拽爪 拽
    const musicTracks = [
        'audio/park/1.mp3',
        'audio/park/2.mp3',
        'audio/park/3.mp3',
        'audio/park/4.mp3'
    ];
    
    // 专转 砖专 拽专 注专
    const randomTrackIndex = Math.floor(Math.random() * musicTracks.length);
    const selectedTrack = musicTracks[randomTrackIndex];
    
    // 爪专转 拽 住 拽转 专拽注
    const backgroundMusic = new Howl({
        src: [selectedTrack],
        loop: true,      //  专
        volume: 0.4,     // 注爪转 砖注 (0-1)
        autoplay: false  //  转 转
    });
    
    // 砖专转 拽 砖转   砖 转住  砖
    window.backgroundMusic = backgroundMusic;
    
    console.log(`专 砖专 专拽注: ${selectedTrack}`);
    
    // 住驻转 驻拽爪 驻注/砖转拽 注 拽砖 M
// 住驻转  拽砖 拽转   拽砖 爪 砖转注 注
document.addEventListener('keydown', (e) => {
    //  转注 注, 注 转 专注 砖专 拽砖 爪
    if (movementLocked) {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown' || 
            e.key === 'ArrowLeft' || e.key === 'ArrowRight' ||
            e.key === 'w' || e.key === 's' || 
            e.key === 'a' || e.key === 'd') {
            e.preventDefault();
        }
    }
}, { passive: false });
    // 住驻转  驻转专 砖转拽/驻注
const musicToggleBtn = document.getElementById('music-toggle');
if (musicToggleBtn) {
    musicToggleBtn.addEventListener('click', () => {
        if (backgroundMusic.playing()) {
            backgroundMusic.pause();
            musicToggleBtn.textContent = '';
            console.log('拽 砖转拽');
        } else {
            backgroundMusic.play();
            musicToggleBtn.textContent = '';
            console.log('拽 驻注');
        }
    });
}
    // 专转 拽 拽专 砖专爪 砖转砖 
    return backgroundMusic;
};
        // 转 住爪
// Modal functionality
// Modal functionality with improved effects for kids

// 住驻转 驻拽 驻注 转 砖
// 住驻转 驻拽 驻注 转 砖
// 住驻转 驻拽 驻注 转 砖

// 驻拽爪 爪转  住专
const setupVideoModal = () => {
    const videoModal = document.getElementById('video-modal');
    const introVideo = document.getElementById('intro-video');
    
    // 爪转  专 3 砖转
    setTimeout(() => {
        videoModal.style.display = 'block';
        
        // 砖转 砖  爪转 住专
        if (controls) {
            controls.enabled = false;
        }
        
        // 砖转 拽转 专拽注  驻注转
        if (window.backgroundMusic && window.backgroundMusic.playing()) {
            window.backgroundMusic.pause();
        }
        
        // 驻注转 住专 转
        introVideo.play();
        
        // 住驻转  住 住专
// 住驻转  住 住专
// 住驻转  住 住专
// 住驻转  住 住专
// 拽 砖 驻 住  (专 砖拽抓 1.mp3 砖注)
introVideo.addEventListener('ended', () => {
    // 住专转  住专
    videoModal.style.display = 'none';
    
    //  砖转注 注 注
    movementLocked = true;
    
    //  砖拽专转 注 砖转转
    if (controls) {
        controls.enabled = false;
    }
    
    // 驻注转 拽转 专拽注  转 砖转拽转
    if (window.backgroundMusic && !window.backgroundMusic.playing()) {
        window.backgroundMusic.play();
    }
    
    // 驻住 转  爪 砖专 拽 注 驻  (专 转专 驻 )
    if (controls) {
        controls.lon = 0;
        controls.lat = -60;  // 注专  0, 注砖 转专 砖
        controls.phi = Math.PI/2 - THREE.MathUtils.degToRad(-60);  // 转 注专 砖 lat
        controls.theta = THREE.MathUtils.degToRad(0);
    }
    
    // 转 砖 3 砖转 驻 驻注转  拽住
    setTimeout(() => {
        playInstructionAudio();
    }, 3000);
});
    }, 3000); // 3 砖转
};
// Add this line to your init function
// 驻拽爪 爪专转 驻拽 转 转
const typewriterEffect = (text, elementId, speed = 100) => {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    element.innerHTML = ''; // 拽 拽住 拽
    
    // 住驻转 住 
    const cursor = document.createElement('span');
    cursor.className = 'typewriter-cursor';
    element.appendChild(cursor);
    
    let i = 0;
    const typing = () => {
        if (i < text.length) {
            // 住驻转 转 住驻转
            const char = document.createTextNode(text.charAt(i));
            element.insertBefore(char, cursor);
            i++;
            setTimeout(typing, speed);
        } else {
            // 住专转 住 专 3 砖转
            setTimeout(() => {
                cursor.style.display = 'none';
            }, 3000);
        }
    };
    
    typing();
};

// 驻拽爪 砖注转 拽 爪转 拽住 转 转
const playInstructionAudio = () => {
    movementLocked = true;

    const instructionSound = new Howl({
        src: ['tutorial/2.mp3'],
        volume: 0.7,
        onend: () => {
            console.log('住 砖注转 专转');

            // 砖专  转转 拽 砖砖专 拽 
            if (initialCameraQuaternion) {
                camera.quaternion.copy(initialCameraQuaternion);
            }

            if (controls) {
                controls.lon = 0;
                controls.lat = -40;
                controls.phi = Math.PI / 2 - THREE.MathUtils.degToRad(-40);
                controls.theta = THREE.MathUtils.degToRad(0);
                controls.update(0);

                controls.enabled = true;
                controls.activeLook = true;
            }

            movementLocked = true;
        }
    });

    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
    }

    // 驻注转 拽注  2
    loadAndPlayVideo(2);
    
    instructionSound.play();

    typewriterEffect('专  转 !\n转 转 专砖, 砖 住转  ,  转 注专 爪 , 注爪专 砖转专 转  注', 'typewriter-text', 80);

    setTimeout(() => {
        if (typewriterContainer) {
            typewriterContainer.style.display = 'none';
        }
    }, 12000);
};

// 驻拽爪 砖 转注 - 转 拽专  专 转专
const setMovementControls = (allowMovement) => {
    movementLocked = !allowMovement;
    console.log(allowMovement ? "转注 驻注" : "转注 注");
};
// 驻拽爪 爪专转 拽 
// 驻拽爪 拽   爪 专  爪
// 驻拽爪 拽   爪 专  爪
// 驻拽爪 拽   爪 专  爪
// 驻拽爪 拽   爪 专  爪
const checkLogoInView = () => {
    // 拽 拽注 砖  
    const rightLogoPosition = new THREE.Vector3(20, 2, -0.41);
    
    // 拽 拽注 砖  砖 (专 砖)
    const leftLogoPosition = new THREE.Vector3(-20, 2, -0.41);
    
    // 拽 拽注 砖  注
    const topLogoPosition = new THREE.Vector3(-20, 15, -0.41);
    
    // 拽 拽注 砖  转转
    const bottomLogoPosition = new THREE.Vector3(-20, 1.7, -0.41);
    
    // 拽 拽注 砖   砖拽
    const playerHeightLogoPosition = new THREE.Vector3(-40, 1.7, -0.41);
    
    // 砖 拽专  爪
    const cameraDirection = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion).normalize();
    
    // 专转  专 砖 砖 砖爪 住转转 注 
    const viewThreshold = 0.97;
    
    // 拽   (拽专)  专 砖注  砖
    if (!logoAudioPlayed) {
        // 砖 拽专 爪  
        const directionToRightLogo = new THREE.Vector3().subVectors(rightLogoPosition, camera.position).normalize();
        const dotProductRight = cameraDirection.dot(directionToRightLogo);
        
        //  爪 住转转 注  
        if (dotProductRight > viewThreshold) {
            // 住 砖 砖注  砖 砖注 砖
            logoAudioPlayed = true;
            
            // 驻注转  注转 
            playLogoAudio();
            
            console.log(` 驻注 -   专 , : ${dotProductRight.toFixed(4)}`);
        }
    }
    
    // 拽  砖    专 砖注  砖 专 砖注
    if (logoAudioPlayed && !leftLogoAudioPlayed) {
        // 砖 拽专 爪  砖
        const directionToLeftLogo = new THREE.Vector3().subVectors(leftLogoPosition, camera.position).normalize();
        const dotProductLeft = cameraDirection.dot(directionToLeftLogo);
        
        //  爪 住转转 注  砖
        if (dotProductLeft > viewThreshold) {
            // 住 砖 砖 砖注
            leftLogoAudioPlayed = true;
            
            // 驻注转  注转  砖
            playLeftLogoAudio();
            
            console.log(` 砖 驻注 -  砖 专 , : ${dotProductLeft.toFixed(4)}`);
        }
    }
    
    // 拽  注  专 砖注   砖
    if (logoAudioPlayed && leftLogoAudioPlayed && !topLogoAudioPlayed) {
        // 砖 拽专 爪  注
        const directionToTopLogo = new THREE.Vector3().subVectors(topLogoPosition, camera.position).normalize();
        const dotProductTop = cameraDirection.dot(directionToTopLogo);
        
        //  爪 住转转 注  注
        if (dotProductTop > viewThreshold) {
            // 住 砖 注 砖注
            topLogoAudioPlayed = true;
            
            // 驻注转  注转  砖
            playTopLogoAudio();
            
            console.log(` 注 驻注 -  注 专 , : ${dotProductTop.toFixed(4)}`);
        }
    }
    
    // 拽  转转  专 砖注   专
    if (logoAudioPlayed && leftLogoAudioPlayed && topLogoAudioPlayed && !bottomLogoAudioPlayed) {
        // 砖 拽专 爪  转转
        const directionToBottomLogo = new THREE.Vector3().subVectors(bottomLogoPosition, camera.position).normalize();
        const dotProductBottom = cameraDirection.dot(directionToBottomLogo);
        
        //  爪 住转转 注  转转
        if (dotProductBottom > viewThreshold) {
            // 住 砖 转转 砖注
            bottomLogoAudioPlayed = true;
            
            // 驻注转  注转  砖
            playBottomLogoAudio();
            
            console.log(` 转转 驻注 -  转转 专 , : ${dotProductBottom.toFixed(4)}`);
        }
    }
    
    // 拽  爪专 驻注 转  砖   砖拽
    if (logoAudioPlayed && leftLogoAudioPlayed && topLogoAudioPlayed && bottomLogoAudioPlayed) {
        // 拽  砖转砖 住驻拽 拽专   砖拽
        const distanceToPlayerHeightLogo = camera.position.distanceTo(playerHeightLogoPosition);
        
        if (distanceToPlayerHeightLogo < 5 && !playerHeightLogoAudioPlayed) {
            // 住 砖 砖   砖拽 砖注
            playerHeightLogoAudioPlayed = true;
            
            // 驻注转  注转  转注
            playPlayerHeightLogoAudio();
            
            console.log(` 砖   砖拽 驻注 - 砖转砖 住驻拽 拽专, 专拽: ${distanceToPlayerHeightLogo.toFixed(2)}`);
        }
    }
    // 驻拽爪转 checkLogoInView - 转拽 拽转 拽专 
// 专 拽 砖  转转, 住祝:

// 拽  砖转砖 住驻拽 拽专   砖拽
if (logoAudioPlayed && leftLogoAudioPlayed && topLogoAudioPlayed && bottomLogoAudioPlayed && !playerHeightLogoAudioPlayed) {
    // 拽   砖拽
    const playerHeightLogoPosition = new THREE.Vector3(-20, 1.7, -0.41);
    
    // 砖 专拽 砖转砖 
    const distanceToPlayerHeightLogo = camera.position.distanceTo(playerHeightLogoPosition);
    console.log(`专拽   砖拽: ${distanceToPlayerHeightLogo.toFixed(2)}`);
    
    //  砖转砖 住驻拽 拽专 (拽 转 住祝 -5 -3)
    if (distanceToPlayerHeightLogo < 3 && !playerHeightLogoAudioPlayed) {
        // 住 砖 砖   砖拽 砖注
        playerHeightLogoAudioPlayed = true;
        
        // 驻注转  注转  转注
        playPlayerHeightLogoAudio();
        
        console.log(` 砖   砖拽 驻注 - 砖转砖 住驻拽 拽专, 专拽: ${distanceToPlayerHeightLogo.toFixed(2)}`);
    }
}
};

// 驻拽爪 驻注转  砖  转转
const playBottomLogoAudio = () => {
    movementLocked = true;
    if (controls) {
        controls.activeLook = false;
        controls.enabled = false;
    }

    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        typewriterEffect('砖!! 注  转 拽爪转, 砖转砖 抓 拽  爪 爪 专 驻转专 砖 砖 注专 砖  砖 注', 'typewriter-text', 80);
    }

    // 驻注转 拽注  6
    loadAndPlayVideo(6);

    const logoSound = new Howl({
        src: ['tutorial/6.mp3'],
        volume: 0.8,
        onend: () => {
            stopWalking();
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            movementLocked = false;

            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }

            moveLogoToPlayerHeight();
        }
    });

    logoSound.play();
};


// 驻拽爪 注专转  拽 砖  砖拽
const moveLogoToPlayerHeight = () => {
    // 爪 转   注专  转 砖转
    const logoModel = customModels.find(model => 
        model.position.x === -20 && 
        model.position.y === -3 && 
        Math.abs(model.position.z - (-0.41)) < 0.1
    );
    
    if (logoModel) {
        // 注 拽  -  专拽 转专  砖拽
        logoModel.position.set(-40, 1.7, -0.41);
        
        // 住   砖驻  转
        logoModel.lookAt(new THREE.Vector3(0, 1.7, 0));
        
        console.log(' 注专 拽 砖  砖拽: X: -40, Y: 1.7, Z: -0.41');
    } else {
        console.error(' 爪   拽 转转');
    }
};

// 驻拽爪 驻注转  砖   砖拽
const playPlayerHeightLogoAudio = () => {
    movementLocked = true;
    if (controls) {
        controls.activeLook = false;
        controls.enabled = false;
    }

    stopWalking(); // 注爪专 转注 转

    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        typewriterEffect('注砖 住 转 专! 爪 注 抓   注 驻转专  砖 注专 转专, 转  专!', 'typewriter-text', 80);
    }

    // 驻注转 拽注  7
    loadAndPlayVideo(7);

    const logoSound = new Howl({
        src: ['tutorial/7.mp3'],
        volume: 0.8,
        onend: () => {
            stopWalking(); //  驻住拽 住驻转
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            movementLocked = false;

            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }
        }
    });

    logoSound.play();
};

// 驻拽爪 驻注转  砖  注
const playTopLogoAudio = () => {
    // 注转 转注 驻 
    movementLocked = true;
    
    // 注转  - 专  砖 驻砖专转 住转 住
    if (controls) {
        // 砖专 注 爪 
        controls.activeLook = false;
        
        // 砖转 转 砖 拽专转
        controls.enabled = false;
    }
    
    // 爪转 注转 拽住 
    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        
        // 驻注 转 驻拽 转 转
        typewriterEffect(' ! 注转 住转  爪注转 转 注专  ! 驻砖 转  注', 'typewriter-text', 80);
    }
    
    // 驻注转 拽注  5
    loadAndPlayVideo(5);
    
    // 爪专转 拽 住
    const logoSound = new Howl({
        src: ['tutorial/5.mp3'],
        volume: 0.8,
        onend: () => {
            console.log('住 砖注转   注');
            
            // 砖专专  注 专拽 专 砖 专
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            
            // 住转专转 注转 拽住 住 
            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }
            
            // 注专转  拽 砖 
            moveLogoToBottomPosition();
        }
    });
    
    // 砖注 转 拽
    logoSound.play();
};

// 驻拽爪 注专转  拽 砖 
// 驻拽爪 注专转  拽 砖  - 转拽  转
const moveLogoToBottomPosition = () => {
    // 爪 转   注专  转 砖转
    const logoModel = customModels.find(model => 
        model.position.x === -20 && 
        model.position.y === 20 && 
        Math.abs(model.position.z - (-0.41)) < 0.1
    );
    
    if (logoModel) {
        // 注 拽  - 砖 -(-3) -1.7 ( 转)
        logoModel.position.set(-20, 1.7, -0.41);
        
        // 住   砖驻  转
        logoModel.lookAt(new THREE.Vector3(0, 1.7, 0));
        
        console.log(' 注专 拽 砖  转: X: -20, Y: 1.7, Z: -0.41');
    } else {
        console.error(' 爪   拽 注');
    }
};

// 驻拽爪 驻注转  砖 
// 驻拽爪 驻注转  砖 
// 驻拽爪 驻注转  砖 
const playLogoAudio = () => {
    // 注转 转注 驻 
    movementLocked = true;
    
    // 注转  - 专  砖 驻砖专转 住转 住
    if (controls) {
        // 砖专 注 爪 
        controls.activeLook = false;
        
        // 砖转 转 砖 拽专转
        controls.enabled = false;
    }
    
    // 爪转 注转 拽住 
    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        
        // 驻注 转 驻拽 转 转
        typewriterEffect('驻! 注砖 住转 爪 砖! 砖转 , 注  转 注专 爪 砖 注 砖转专 转  砖 注', 'typewriter-text', 80);
    }
    
    // 驻注转 拽注  3
    loadAndPlayVideo(3);
    
    // 爪专转 拽 住
    const logoSound = new Howl({
        src: ['tutorial/3.mp3'],
        volume: 0.8,
        onend: () => {
            console.log('住 砖注转  ');
            
            // 砖专专  注 专拽 专 砖 专
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            
            // 住转专转 注转 拽住 住 
            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }
            
            // 注专转  拽 砖
            moveLogoToNewPosition();
        }
    });
    
    // 砖注 转 拽
    logoSound.play();
};


// 驻拽爪 爪转 注转 拽住 转 转
// 驻拽爪 爪转 注转 拽住 转 转


// 驻拽爪 注专转  拽 砖
const moveLogoToNewPosition = () => {
    // 爪 转   注专  转 砖转
    const logoModel = customModels.find(model => 
        model.position.x === 20 && 
        model.position.y === 2 && 
        Math.abs(model.position.z - (-0.41)) < 0.1
    );
    
    if (logoModel) {
        // 注 拽 
        logoModel.position.set(-20, 2, -0.41);
        
        // 住   砖驻  转
        const direction = new THREE.Vector3(0, 0, 0).sub(logoModel.position).normalize();
        logoModel.lookAt(new THREE.Vector3(0, 2, 0));
        // 住 住祝  爪专  砖   
        logoModel.rotation.y += Math.PI;
        
        console.log(' 注专 拽 砖: X: -20, Y: 2, Z: -0.41');
    } else {
        console.error(' 爪   拽 拽专');
    }
};
// 驻拽爪 驻注转  砖  砖
const playLeftLogoAudio = () => {
    // 注转 转注 驻 
    movementLocked = true;
    
    // 注转  - 专  砖 驻砖专转 住转 住
    if (controls) {
        // 砖专 注 爪 
        controls.activeLook = false;
        
        // 砖转 转 砖 拽专转
        controls.enabled = false;
    }
    
    // 爪转 注转 拽住 
    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        
        // 驻注 转 驻拽 转 转
        typewriterEffect('驻! 注砖   住转 注, 住转 注 驻砖 转  注!', 'typewriter-text', 80);
    }
    
    // 驻注转 拽注  4
    loadAndPlayVideo(4);
    
    // 爪专转 拽 住
    const logoSound = new Howl({
        src: ['tutorial/4.mp3'],
        volume: 0.8,
        onend: () => {
            console.log('住 砖注转   砖');
            
            // 砖专专  注 专拽 专 砖 专
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            
            // 住转专转 注转 拽住 住 
            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }
            
            // 注专转  拽 砖 注
            moveLogoToTopPosition();
        }
    });
    
    // 砖注 转 拽
    logoSound.play();
};
// 驻拽爪 注专转  拽 砖 注
// 驻拽爪 注专转  拽 砖 注

// 驻拽爪 拽  砖拽  专
// 驻拽爪 拽  砖拽  专 - 专住 砖驻专转
// 砖 砖   专


let backwardListenersSet = false;  // 抓 驻拽爪
const backwardAutoMoveDuration = 2000; // 砖  转注 专 (2 砖转)

const checkBackwardMovement = () => {
    if (walkingBackwardChecked || !playerHeightLogoAudioPlayed || backwardListenersSet) {
        return;
    }

    backwardListenersSet = true;

    const backwardCheck = (event) => {
        if (event.key === 'ArrowDown' || event.key === 's') {
            walkingBackwardChecked = true;
            document.removeEventListener('keydown', backwardCheck);
            document.removeEventListener('mousedown', backwardMouseCheck);

            autoMoveBackward(backwardAutoMoveDuration); // 驻注 转注 专
        }
    };

    const backwardMouseCheck = (event) => {
        if (event.button === 2) {
            walkingBackwardChecked = true;
            document.removeEventListener('keydown', backwardCheck);
            document.removeEventListener('mousedown', backwardMouseCheck);

            autoMoveBackward(backwardAutoMoveDuration); // 驻注 转注 专
        }
    };

    document.addEventListener('keydown', backwardCheck);
    document.addEventListener('mousedown', backwardMouseCheck);
};

// 驻拽爪 转注 专 驻 
const autoMoveBackward = (duration) => {
    movementLocked = true;

    const moveSpeed = 0.03; // 专转 转注 专转
    const moveInterval = 16; // 专 转注 (~60FPS)
    const totalSteps = duration / moveInterval;
    let steps = 0;

    const moveIntervalId = setInterval(() => {
        if (steps >= totalSteps) {
            clearInterval(moveIntervalId);
            stopWalking();
            playFinalAudio(); // 驻注  专 转注
            return;
        }

        const backwardVector = new THREE.Vector3(0, 0, 1).applyQuaternion(camera.quaternion);
        backwardVector.y = 0;
        backwardVector.normalize().multiplyScalar(moveSpeed);

        camera.position.add(backwardVector);

        steps++;
    }, moveInterval);
};


// 驻拽爪 注专转  拽 砖 注 -  住驻转
const moveLogoToTopPosition = () => {
    // 爪 转   注专  转 砖转
    const logoModel = customModels.find(model => 
        model.position.x === -20 && 
        model.position.y === 2 && 
        Math.abs(model.position.z - (-0.41)) < 0.1
    );
    
    if (logoModel) {
        // 注 拽  - 转 注专 -Y -15 -20
        logoModel.position.set(-20, 20, -0.41);
        
        // 住   砖驻   转
        logoModel.lookAt(new THREE.Vector3(0, 2, 0));
        
        console.log(' 注专 拽 砖 注: X: -20, Y: 20, Z: -0.41');
    } else {
        console.error(' 爪   拽 砖');
    }
};

// 注 拽 拽注 砖  注 驻拽爪转 checkLogoInView
// 转 驻拽爪 砖 砖转 转 砖专 砖专 转 拽  注:
const topLogoPosition = new THREE.Vector3(-20, 20, -0.41); // 砖 -15 -20
// 驻拽爪 驻注转  住驻
let finalAudioPlayed = false;

const playFinalAudio = () => {
    if (finalAudioPlayed) return;
    finalAudioPlayed = true;

    movementLocked = true;

    if (controls) {
        controls.activeLook = false;
        controls.enabled = false;
    }

    stopWalking();

    const typewriterContainer = document.getElementById('typewriter-container');
    if (typewriterContainer) {
        typewriterContainer.style.display = 'block';
        typewriterEffect('驻! 注砖 转  转 住注 驻砖 转 注专 住 住 !', 'typewriter-text', 80);
    }

    // 驻注转 拽注  8 ( 拽)
    loadAndPlayVideo(8);

    const finalSound = new Howl({
        src: ['tutorial/8.mp3'],
        volume: 0.8,
        onend: () => {
            if (controls) {
                controls.enabled = true;
                controls.activeLook = true;
            }
            movementLocked = false;

            if (typewriterContainer) {
                typewriterContainer.style.display = 'none';
            }

            isPortalVisible = true;
            if (portalParticles) {
                portalParticles.visible = true;
            }

            const portalLight = scene.getObjectByName('portalLight');
            if (portalLight) {
                portalLight.visible = true;
            }

            hideTechnodaLogo(); // 注转  住
        }
    });

    finalSound.play();
};
// 驻拽爪 注转  注
const hideTechnodaLogo = () => {
    customModels.forEach(model => {
        scene.remove(model);
    });
    
    // 住转专 转   住
    hideVideoContainer();
};

// 驻拽爪 驻住 爪 
const stopWalking = () => {
    if (walkSound && walkSound.playing()) {
        walkSound.pause();
        isWalking = false;
    }
    // 驻住 驻 砖 FirstPersonControls
    if (controls) {
        controls.moveForward = false;
        controls.moveBackward = false;
    }
};
document.addEventListener('mousedown', (e) => {
    if ((e.button === 0 || e.button === 2) && !isWalking && !movementLocked && controls && controls.enabled) {
        walkSound.play();
        isWalking = true;
    }
});

//  砖专专 驻转专 注专
document.addEventListener('mouseup', (e) => {
    if ((e.button === 0 || e.button === 2)) {
        stopWalking();
    }
});
// 驻拽爪 注转 爪转 拽注 
// 驻拽爪 注转 爪转 拽注 
const loadAndPlayVideo = (clipNumber) => {
    const videoContainer = document.getElementById('tutorial-video-container');
    const video = document.getElementById('tutorial-video');
    
    if (!video) return;
    
    // 注 拽专 
    video.src = `tutorial/${clipNumber}.mp4`;
    currentVideoClip = clipNumber;
    
    // 爪转  
    videoContainer.style.display = 'block';
    
    // 专注 注转 
    video.onloadedmetadata = () => {
        // 驻注转 
        video.play().catch(error => {
            console.warn(' 转 驻注 转  驻 :', error);
        });
    };
    
    // 砖专  专,  驻砖 专 转 砖 (驻)
    video.loop = true;
    
    // 驻 砖转 注转 
    video.onerror = () => {
        console.error(`砖 注转  ${clipNumber}.mp4`);
        //   住转专 转  拽专 砖 砖,  专拽 爪 注   驻
        // videoContainer.style.display = 'none';
    };
    
    console.log(`注  专 住驻专 ${clipNumber}`);
};
const init = () => {
    setupLighting();
    createGround();
    const backgroundMusic = setupBackgroundMusic();
    setupFirstPersonControls();
    setupWalkSound();
    createPortalEffect();
    loadGLB();
    loadTechnodaModels();

    // 砖专 转   转转 (Quaternion)
    // 拽注转 转 爪 转 驻 砖专转 -quaternion
    if (controls) {
        controls.lon = 0;
        controls.lat = -60;  // 转专 驻 
        controls.phi = Math.PI/2 - THREE.MathUtils.degToRad(-60);
        controls.theta = THREE.MathUtils.degToRad(0);
        controls.update(0);  // 砖! 注  砖 拽专转
    }
    
    // 砖专转 爪 注
    initialCameraQuaternion = camera.quaternion.clone();

    setupVideoModal();
    animate();
};
        
        // 驻拽爪 注转  注 住驻专 拽转
        const loadTechnodaModels = () => {
    const technodaPath = '3d/technoda.glb';
    
    // 注转 
    const loader = new THREE.GLTFLoader();
    loader.load(
        technodaPath,
        (gltf) => {
            const logoModel = gltf.scene;
            
            // 专转 爪
            logoModel.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
            });
            
            // 住拽 转 
            const scale = 2.0;  //   转专  砖 
            logoModel.scale.set(scale, scale, scale);
            
            // 拽 拽注 拽转 砖转拽砖
            logoModel.position.set(20, 2, -0.41);
            
            // 住   砖驻  转 转
            // 砖  转 (0,0,0)
            const direction = new THREE.Vector3(0, 0, 0).sub(logoModel.position).normalize();
            logoModel.lookAt(new THREE.Vector3(0, 2, 0));
            // 住 住祝  爪专  砖   
            logoModel.rotation.y += Math.PI;
            
            // 砖专转  注专  转 砖转
            customModels.push(logoModel);
            
            // 住驻 住爪
            scene.add(logoModel);
            
            console.log(' 注 注 爪 拽 拽注: X: 20, Y: 2, Z: -0.41');
        },
        (xhr) => {
            console.log(`注转  注: ${Math.round((xhr.loaded / xhr.total) * 100)}%`);
        },
        (error) => {
            console.error('砖 注转  注:', error);
        }
    );
};
        
        // 驻拽爪转 爪
// 驻拽爪转 爪
// 驻拽爪转 爪
// 驻拽爪转 爪
const animate = () => {
    requestAnimationFrame(animate);
    
    if (isLoaded) {
        const delta = clock.getDelta();
        
        if (controls) {
            // 砖专转 拽 拽 驻 注
            const previousPosition = camera.position.clone();
            
            if (controls.enabled) {
                // 砖专转 专    注
                if (!controls.activeLook) {
                    // 砖专转 转 砖  
                    const currentLon = controls.lon;
                    const currentLat = controls.lat;
                    const currentPhi = controls.phi;
                    const currentTheta = controls.theta;
                    
                    // 注  拽专转
                    controls.update(delta);
                    
                    // 专转  拽 ( 砖 )
                    controls.lon = currentLon;
                    controls.lat = currentLat;
                    controls.phi = currentPhi;
                    controls.theta = currentTheta;
                    
                    //  转注
                    camera.position.copy(previousPosition);
                } else if (movementLocked) {
                    // 爪 砖   注  转注 
                    const currentPosition = camera.position.clone();
                    controls.update(delta);
                    camera.position.copy(currentPosition);
                    
                    // 拽  爪 住转转 注  ( 爪 注转 转注)
                    checkLogoInView();
                } else {
                    // 注 专 砖专  砖专专
                    controls.update(delta);
                    
                    if (checkTreeCollisions(camera.position)) {
                        camera.position.copy(previousPosition);
                    }
                    
                    // 拽  爪 住转转 注 
                    checkLogoInView();
                    
                    // 拽转 转注 专 - 住祝 转  专拽   砖   砖拽 专 砖注
                    if (playerHeightLogoAudioPlayed && !walkingBackwardChecked && !movementLocked) {
    checkBackwardMovement();
}
                }
                
                // 砖 拽 专...
                const groundHeight = getGroundHeight(camera.position.x, camera.position.z);
                camera.position.y = groundHeight + PLAYER_HEIGHT;
                
                // 拽转 住驻转
                checkInteractionPoint();
                checkCustomLocationPoints(camera.position);
            }
        }
        
        animatePortal();
    }
    
    renderer.render(scene, camera);
};
        
        // 驻注转 转 砖祝 注
        window.addEventListener('load', init);
    </script>