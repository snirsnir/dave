<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¢×•×œ× ×ª×œ×ª ××™××“×™ ×¢× Three.js</title>
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×•×ª Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/FirstPersonControls.js"></script>
    <!-- ×˜×¢×™× ×ª ×¡×¤×¨×™×™×ª Audio -->
    <script src="https://cdn.jsdelivr.net/npm/howler@2.2.3/dist/howler.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            cursor: default;
        }
        
        #scene-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
        }
        
        #controls-info {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 100;
        }
        
        #next-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            display: none;
        }
        
        #back-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            pointer-events: none;
            z-index: 100;
        }
    </style>
</head>
<body>
    <!-- Modal for video -->
<div id="video-modal" style="
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.7);
z-index: 1000;
font-family: 'Varela Round', Arial, sans-serif;
">
<div style="
    position: relative;
    background-color: #000;
    margin: 5% auto;
    width: 90%;
    max-width: 800px;
    border-radius: 25px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
    animation: modalPopIn 0.7s;
    direction: rtl;
    border: 8px solid #FF5722;
">
    <div style="
        background: linear-gradient(to left, #FF5722, #FF8A65);
        color: white;
        padding: 20px;
        border-radius: 17px 17px 0 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    ">
        <div style="position: relative; display: inline-block;">
            <h2 style="margin: 0; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: bold;">×‘×¨×•×›×™× ×”×‘××™× ×œ××©×—×§×™×™×”!</h2>
        </div>
        <span id="close-video-modal" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: white; font-size: 36px; font-weight: bold; cursor: pointer;">âœ–ï¸</span>
    </div>
    <div style="padding: 0; background-color: black; border-radius: 0 0 17px 17px;">
        <video id="intro-video" width="100%" controls style="display: block; border-radius: 0 0 17px 17px;">
            <source src="vid/4.mp4" type="video/mp4">
            ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×ª×’×™×ª ×•×™×“××•.
        </video>
    </div>
</div>
</div>

<style>
@keyframes modalPopIn {
0% { transform: scale(0.5); opacity: 0; }
50% { transform: scale(1.05); opacity: 0.8; }
100% { transform: scale(1); opacity: 1; }
}
</style>
<!-- Mission popup -->
<div id="mission-popup" style="
    opacity: 0;
    position: fixed;
    top: 5px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 999;
    width: auto;
    max-width: 90%;
    animation: float 3s ease-in-out infinite;
">
    <div style="
        background: linear-gradient(135deg, rgba(230, 250, 240, 0.9), rgba(210, 240, 255, 0.95));
        border: 3px solid #FF5722;
        border-radius: 15px;
        padding: -10px;
        box-shadow: 0 0 15px rgba(255, 87, 34, 0.6), 0 0 30px rgba(0, 0, 0, 0.3);
    ">
        <div style="
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            position: relative;
            z-index: 1;
        ">
            <div style="
                font-size: 28px;
                margin-left: 15px;
                color: #FF5722;
                text-shadow: 0 0 10px rgba(255, 87, 34, 0.7);
            ">ğŸ®</div>
            <div style="text-align: right;">
                <div style="
                    color: #333;
                    font-size: 16px;
                    font-weight: bold;
                    text-shadow: 0 0 3px rgba(255, 255, 255, 0.8);
                ">×ª×”× ×•!</div>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes float {
    0% { transform: translate(-50%, 0px); }
    50% { transform: translate(-50%, -10px); }
    100% { transform: translate(-50%, 0px); }
}
</style>
    <div id="scene-container"></div>
    
    <div id="loading">×˜×•×¢×Ÿ ××ª ×”×¢×•×œ×...</div>
    
    <div id="controls-info">
        <p>×ª× ×•×¢×” ×§×“×™××”: ×”×§×©×” ×¢×œ ×§×œ×™×§ ×©×××œ×™ ×‘×¢×›×‘×¨</p>
        <p>×ª× ×•×¢×” ××—×•×¨×”: ×”×§×©×” ×¢×œ ×§×œ×™×§ ×™×× ×™ ×‘×¢×›×‘×¨</p>
        <p>××‘×˜: ×”×–×™×–×• ××ª ×”×¢×›×‘×¨</p>
    </div>
    
    <div id="crosshair">+</div>
    
    <div id="next-screen">
        <h1>×”×’×¢×ª ×œ×™×¢×“!</h1>
        <p>×–×”×• ×”××¡×š ×”×‘×.</p>
        <button id="back-button">×—×–×¨×” ×œ×¢×•×œ×</button>
    </div>
    <!-- Modal for ending video -->
<div id="ending-video-modal" style="
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.9);
z-index: 2000;
font-family: 'Varela Round', Arial, sans-serif;
">
<div style="
    position: relative;
    background-color: #000;
    margin: 5% auto;
    width: 90%;
    max-width: 800px;
    border-radius: 25px;
    box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
    animation: modalPopIn 0.7s;
    direction: rtl;
    border: 8px solid #8A2BE2;
">
    <div style="
        background: linear-gradient(to left, #8A2BE2, #9370DB);
        color: white;
        padding: 20px;
        border-radius: 17px 17px 0 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
    ">
        <div style="position: relative; display: inline-block;">
            <h2 style="margin: 0; font-size: 32px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-weight: bold;">×”××¡×¢ ×××©×™×š...</h2>
        </div>
    </div>
    <div style="padding: 0; background-color: black; border-radius: 0 0 17px 17px;">
        <video id="ending-video" width="100%" style="display: block; border-radius: 0 0 17px 17px;">
            <source src="vid/5.mp4" type="video/mp4">
            ×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×ª×’×™×ª ×•×™×“××•.
        </video>
    </div>
</div>
</div>
    <script>
        // ×™×¦×™×¨×ª ×¡×¦× ×”, ××¦×œ××” ×•×¨× ×“×¨×¨
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-12.86, 10.20, 32.68); // ××™×§×•× ×”×ª×—×œ×ª×™ ×—×“×© ×œ×©×—×§×Ÿ
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // ×¦×œ×œ×™× ×¨×›×™× ×™×•×ª×¨
        
        // ×”×’×“×¨×ª ×¦×‘×¢ ×¨×§×¢ ×©××™×™× ×›×—×•×œ
        renderer.setClearColor(0x6495ED);
        document.getElementById('scene-container').appendChild(renderer.domElement);
        
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let controls;
        let worldModel;
        let isLoaded = false;
        let clock = new THREE.Clock();
        let ground; // ××©×ª× ×” ×œ×©××™×¨×ª ×”×¨×¦×¤×”
        let tunnelObject; // ××©×ª× ×” ×œ×©××™×¨×ª ×”×× ×”×¨×”
        let tunnelWalls = []; // ××¢×¨×š ×œ×©××™×¨×ª ×§×•×œ×™×“×¨×™× ×©×œ ×§×™×¨×•×ª ×”×× ×”×¨×”
        let gameMachinePortals = [];
        let playerCoins = 20; // ××¡×¤×¨ ×”××˜×‘×¢×•×ª ×”×”×ª×—×œ×ª×™
        let visitedGames = []; // ××¢×¨×š ×œ××¢×§×‘ ××—×¨×™ ××©×—×§×™× ×©×›×‘×¨ ×‘×™×§×¨×ª ×‘×”×
        let mainPortalVisible = false;
        const WORLD_BOUNDS = {
    minX: -20,
    maxX: 20,
    minZ: -20,
    maxZ: 20
};
        
        // ××©×ª× ×™× ×œ××•×“×™×•
        let walkSound;
        let isWalking = false;
        const PLAYER_HEIGHT = 2.2;
        // × ×§×•×“×ª ×”××¢×‘×¨ ×”××™×•×—×“×ª ×œ××¡×š ×”×‘×
        const specialPortalPoint = new THREE.Vector3(-15.23, 2.20, 0.27); // ×¢×“×›×•×Ÿ ×’×•×‘×” ×”×¤×•×¨×˜×œ
        const portalRadius = 6; // ×¨×“×™×•×¡ ×’×“×•×œ ×™×•×ª×¨ ×œ××–×•×¨ ×”×¤×•×¨×˜×œ
        let portalParticles; // ××©×ª× ×” ×œ×©××™×¨×ª ××¢×¨×›×ª ×”×—×œ×§×™×§×™× ×©×œ ×”×¤×•×¨×˜×œ
        // ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ××•×“×œ ×”-DJ
let djModel;
// ×”×•×¡×£ ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×¢×§×•×‘ ××—×¨×™ ××¦×‘ ×”×ª× ×•×¢×”
let movingForward = false;
let movingBackward = false;

// ×¤×•× ×§×¦×™×” ×œ×©×œ×™×˜×” ×‘×ª× ×•×¢×”
const setupMovementControls = () => {
    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ××™×¨×•×¢ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×¢×›×‘×¨
    document.addEventListener('mousedown', (e) => {
        // ×‘×“×™×§×” ×× ×œ×—×¥ ×›×¤×ª×•×¨ ×©×××œ×™ (0)
        if (e.button === 0) {
            movingForward = true;
            if (controls) controls.moveForward = true;
            
            if (!isWalking && walkSound) {
                walkSound.play();
                isWalking = true;
            }
        }
        // ×‘×“×™×§×” ×× ×œ×—×¥ ×›×¤×ª×•×¨ ×™×× ×™ (2)
        else if (e.button === 2) {
            movingBackward = true;
            if (controls) controls.moveBackward = true;
            
            if (!isWalking && walkSound) {
                walkSound.play();
                isWalking = true;
            }
        }
    });
    
    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ××™×¨×•×¢ ×©×—×¨×•×¨ ×›×¤×ª×•×¨ ×”×¢×›×‘×¨
    document.addEventListener('mouseup', (e) => {
        // ×‘×“×™×§×” ×× ×©×•×—×¨×¨ ×›×¤×ª×•×¨ ×©×××œ×™ (0)
        if (e.button === 0) {
            movingForward = false;
            if (controls) controls.moveForward = false;
            
            // ×¢×•×¦×¨ ×¦×œ×™×œ ×¨×§ ×× ×’× ×§×“×™××” ×•×’× ××—×•×¨×” ×œ× ×¤×¢×™×œ×™×
            if (isWalking && !movingBackward && walkSound) {
                walkSound.pause();
                isWalking = false;
            }
        }
        // ×‘×“×™×§×” ×× ×©×•×—×¨×¨ ×›×¤×ª×•×¨ ×™×× ×™ (2)
        else if (e.button === 2) {
            movingBackward = false;
            if (controls) controls.moveBackward = false;
            
            // ×¢×•×¦×¨ ×¦×œ×™×œ ×¨×§ ×× ×’× ×§×“×™××” ×•×’× ××—×•×¨×” ×œ× ×¤×¢×™×œ×™×
            if (isWalking && !movingForward && walkSound) {
                walkSound.pause();
                isWalking = false;
            }
        }
    });
    
    // ×¢×¦×™×¨×ª ×ª× ×•×¢×” ××•×˜×•××˜×™×ª ×›×©×¢×•×–×‘×™× ××ª ×”×¢××•×“ ××• ×¢×•×‘×¨×™× ×œ×œ×©×•× ×™×ª ××—×¨×ª
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            // ×× ×”×¢××•×“ ×”×•×¡×ª×¨, ×¢×¦×•×¨ ××ª ×›×œ ×”×ª× ×•×¢×”
            if (controls) {
                controls.moveForward = false;
                controls.moveBackward = false;
            }
            movingForward = false;
            movingBackward = false;
            
            if (isWalking && walkSound) {
                walkSound.pause();
                isWalking = false;
            }
        }
    });
    
    // ×¢×¦×™×¨×ª ×ª× ×•×¢×” ×›×©×¢×•×–×‘×™× ××ª ×”×¢××•×“
    window.addEventListener('beforeunload', () => {
        if (controls) {
            controls.moveForward = false;
            controls.moveBackward = false;
        }
        movingForward = false;
        movingBackward = false;
        
        if (isWalking && walkSound) {
            walkSound.pause();
            isWalking = false;
        }
    });
    
    // ×× ×™×¢×ª ×ª×¤×¨×™×˜ ×§×œ×™×§ ×™×× ×™
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
    });
};
// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××•×“×œ ×”-DJ
const loadDJModel = () => {
    const loader = new THREE.GLTFLoader();
    
    loader.load(
        '3d/dj.glb',
        (gltf) => {
            djModel = gltf.scene;
            
            // ×”×’×“×¨×ª ×¦×œ×œ×™× ×œ×›×œ ×”××©×™× ×‘××•×“×œ
            djModel.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
            });
            
            // ××™×§×•× ×”××•×“×œ ×‘×§×•××•×¨×“×™× ×˜×•×ª ×”××‘×•×§×©×•×ª
            djModel.position.set(0.04, 1.60, -9.01);
            
            // ×¡×™×‘×•×‘ ×”××•×“×œ ×œ×›×™×•×•×Ÿ ×”× ×›×•×Ÿ (×ª×•×›×œ ×œ×”×ª××™× ××ª ×”×–×•×•×™×ª)
            djModel.rotation.y = Math.PI * 0.1; // 90 ××¢×œ×•×ª - ×›×™×•×•×Ÿ ×œ×¦×“
            
            // ×”×ª×××ª ×’×•×“×œ ×”××•×“×œ (×ª×•×›×œ ×œ×©× ×•×ª ×œ×¤×™ ×”×¦×•×¨×š)
            djModel.scale.set(4, 4, 4);
            
            // ×”×•×¡×¤×ª ×”××•×“×œ ×œ×¡×¦× ×”
            scene.add(djModel);
            
            console.log('××•×“×œ ×”-DJ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”');
            
            // ××¤×©×¨×•×ª ×œ×”×•×¡×™×£ ×ª××•×¨×” ××™×•×—×“×ª ×œ-DJ
            addDJLighting();
        },
        (xhr) => {
            console.log('×˜×¢×™× ×ª ××•×“×œ ×”-DJ: ' + (xhr.loaded / xhr.total * 100) + '% ×˜×¢×•×Ÿ');
        },
        (error) => {
            console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ××•×“×œ ×”-DJ:', error);
        }
    );
};

// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª××•×¨×” ××™×•×—×“×ª ×œ-DJ
const addDJLighting = () => {
    // ×ª××•×¨×” ×¦×‘×¢×•× ×™×ª ××ª×—×œ×¤×ª ×¡×‘×™×‘ ×”-DJ
    const colors = [0xff0000, 0x00ff00, 0x0000ff, 0xff00ff, 0xffff00];
    
    colors.forEach((color, index) => {
        // ×™×¦×™×¨×ª ××•×¨ × ×§×•×“×ª×™ ×‘×¦×‘×¢ ×¡×¤×¦×™×¤×™
        const light = new THREE.PointLight(color, 0.5, 5);
        
        // ××™×§×•× ×”××•×¨ ×¡×‘×™×‘ ×”-DJ
        const angle = (index / colors.length) * Math.PI * 2;
        const radius = 2;
        
        light.position.set(
            0.04 + Math.cos(angle) * radius,
            3.5,  // ××¢×œ ×”-DJ
            -9.01 + Math.sin(angle) * radius
        );
        
        // ×”×•×¡×¤×ª ×”××•×¨ ×œ×¡×¦× ×”
        scene.add(light);
        
        // ×× ×™××¦×™×” ×œ××•×¨ - ×©×™× ×•×™ ×¢×•×¦××” ×¢× ×”×–××Ÿ
        const clock = new THREE.Clock();
        const animateLight = () => {
            const elapsed = clock.getElapsedTime();
            light.intensity = 0.3 + Math.sin(elapsed * 2 + index) * 0.2;
            
            requestAnimationFrame(animateLight);
        };
        
        animateLight();
    });
};
        // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ××•×“××œ ×”×¡×‘×¨×™× ×‘×¡×’× ×•×Ÿ ×¨×˜×¨×•
// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ××•×“××œ ×”×¡×‘×¨×™× ×‘×¡×’× ×•×Ÿ ×¨×˜×¨×• - ×’×¨×¡×” ××©×•×¤×¨×ª
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××•×“×œ ×”×¡×¨×˜×•×Ÿ
const setupVideoModal = () => {
    const videoModal = document.getElementById('video-modal');
    const introVideo = document.getElementById('intro-video');
    const closeBtn = document.getElementById('close-video-modal');
    
    // ×”×¦×’×ª ×”××•×“×œ ××—×¨×™ 3 ×©× ×™×•×ª
    setTimeout(() => {
        videoModal.style.display = 'flex';
        
        // ×”×©×‘×ª×ª ×”×©×œ×™×˜×” ×‘×–××Ÿ ×”×¦×’×ª ×”×¡×¨×˜×•×Ÿ
        if (controls) {
            controls.enabled = false;
        }
        
        // ×¢×¦×™×¨×ª ×›×œ ×”×¦×œ×™×œ×™×
        if (window.backgroundMusic && window.backgroundMusic.playing()) {
            window.backgroundMusic.pause();
        }
        
        // ×”×¤×¢×œ×ª ×”×¡×¨×˜×•×Ÿ ××•×˜×•××˜×™×ª
        introVideo.play();
        
        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×¡×™×•× ×”×¡×¨×˜×•×Ÿ
        introVideo.addEventListener('ended', () => {
            closeVideoAndShowWelcomeModal();
        });
        
        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×›×¤×ª×•×¨ ×”×¡×’×™×¨×”
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                closeVideoAndShowWelcomeModal();
            });
        }
    }, 3000); // 3 ×©× ×™×•×ª
};

// ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×”×¡×¨×˜×•×Ÿ ×•×”×¦×’×ª ××•×“×œ ×”×”×¡×‘×¨
const closeVideoAndShowWelcomeModal = () => {
    const videoModal = document.getElementById('video-modal');
    const introVideo = document.getElementById('intro-video');
    
    // ×¢×¦×™×¨×ª ×”×¡×¨×˜×•×Ÿ
    introVideo.pause();
    
    // ×¡×’×™×¨×ª ×”××•×“×œ
    videoModal.style.display = 'none';
    
    // ×”×¦×’×ª ×”××•×“×œ ×©×œ Welcome (×”×”×¡×‘×¨)
    createWelcomeModal();
};
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”××©×™××”
const setupMissionPopup = () => {
    const missionPopup = document.getElementById('mission-popup');
    
    // ××—×‘×™××™× ××ª ×”×—×œ×•× ×™×ª ×‘×”×ª×—×œ×”
    if (missionPopup) {
        missionPopup.style.opacity = '0';
        
        // ×”××©×™××” ×ª×•×¦×’ ×¨×§ ××—×¨×™ ×¡×’×™×¨×ª ××•×“×œ ×”×”×¡×‘×¨ (Welcome)
        document.addEventListener('welcomeModalClosed', () => {
            setTimeout(() => {
                missionPopup.style.opacity = '1';
                missionPopup.style.transition = 'opacity 1.5s ease-out';
            }, 1000);
        });
    } else {
        console.error("Mission popup element not found!");
    }
};
// ×¡×’×™×¨×ª ×”××•×“××œ ×‘×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨

const createWelcomeModal = () => {
    if (controls) {
        controls.enabled = false;
    }
    // ×™×¦×™×¨×ª ×”××•×“××œ
    const modal = document.createElement('div');
    modal.id = 'welcome-modal';
    
    // ×¡×’× ×•×Ÿ ×¨×˜×¨×• ×œ××•×“××œ
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.85)';
    modal.style.zIndex = '1000';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.fontFamily = "'Press Start 2P', 'Courier New', monospace";
    
    // ×™×¦×™×¨×ª ×ª×•×›×Ÿ ×”××•×“××œ - ×’×“×•×œ ×™×•×ª×¨
    const modalContent = document.createElement('div');
    modalContent.style.backgroundColor = '#000';
    modalContent.style.border = '5px solid #39ff14'; // × ×™××•×Ÿ ×™×¨×•×§ ×¢×‘×” ×™×•×ª×¨
    modalContent.style.borderRadius = '15px';
    modalContent.style.width = '90%';
    modalContent.style.maxWidth = '700px'; // ×¨×•×—×‘ ××§×¡×™××œ×™ ×’×“×•×œ ×™×•×ª×¨
    modalContent.style.padding = '40px'; // ×¨×™×¤×•×“ ×’×“×•×œ ×™×•×ª×¨
    modalContent.style.color = '#fff';
    modalContent.style.position = 'relative';
    modalContent.style.boxShadow = '0 0 20px #39ff14, 0 0 30px #39ff14, inset 0 0 15px rgba(57, 255, 20, 0.5)';
    modalContent.style.animation = 'neonFlicker 2s infinite alternate';
    
    // ×›×•×ª×¨×ª ×‘×¡×’× ×•×Ÿ ×¨×˜×¨×• - ×’×“×•×œ×” ×™×•×ª×¨
    const title = document.createElement('h1');
    title.textContent = '×‘×¨×•×›×™× ×”×‘××™× ×œ××©×—×§×™×”';
    title.style.color = '#FF00FF'; // × ×™××•×Ÿ ×•×¨×•×“
    title.style.fontSize = '36px'; // ×’×•×“×œ ×’×“×•×œ ×™×•×ª×¨
    title.style.marginBottom = '35px';
    title.style.textShadow = '0 0 10px #FF00FF, 0 0 20px #FF00FF';
    title.style.fontWeight = 'bold';
    title.style.letterSpacing = '2px';
    title.style.textAlign = 'right'; // ×™×™×©×•×¨ ×œ×™××™×Ÿ
    
    // ×ª×•×›×Ÿ ×”××•×“××œ - ×’×“×•×œ ×•××™×•×©×¨ ×™×•×ª×¨
    const content = document.createElement('div');
    content.style.fontSize = '22px'; // ×’×•×¤×Ÿ ×’×“×•×œ ×™×•×ª×¨ ××©××¢×•×ª×™×ª
    content.style.lineHeight = '1.8'; // ×¨×•×•×— ×‘×™×Ÿ ×©×•×¨×•×ª ×’×“×•×œ ×™×•×ª×¨
    content.style.marginBottom = '40px';
    content.style.color = '#00FFFF'; // ×¦×™××Ÿ × ×™××•×Ÿ
    content.style.textShadow = '0 0 5px #00FFFF';
    content.style.direction = 'rtl';
    content.style.textAlign = 'right'; // ×™×™×©×•×¨ ×œ×™××™×Ÿ
    content.style.paddingRight = '20px'; // ×¨×•×•×— ××™××™×Ÿ ×œ××¨××” ××¡×•×“×¨ ×™×•×ª×¨
    
    // ×”×•×¡×¤×ª ×”×˜×§×¡×˜ ×¢× × ×§×•×“×•×ª ×•××™×•×©×¨ ×œ×™××™×Ÿ
    content.innerHTML = `
        <div style="display: flex; margin-bottom: 15px; align-items: center;">
            <div style="color: #FFFF00; font-size: 24px; margin-left: 10px;">â€¢</div>
            <div>×œ×¤× ×™×›× 6 ××›×•× ×•×ª ×¢× ××©×—×§×™ ×¢×‘×¨</div>
        </div>
        
        <div style="display: flex; margin-bottom: 15px; align-items: center;">
            <div style="color: #FFFF00; font-size: 24px; margin-left: 10px;">â€¢</div>
            <div>×‘×¨×©×•×ª×›× <span style="color: #FFFF00; font-size: 26px; text-shadow: 0 0 10px #FFFF00;">20 ××˜×‘×¢×•×ª</span></div>
        </div>
        
        <div style="display: flex; margin-bottom: 15px; align-items: center;">
            <div style="color: #FFFF00; font-size: 24px; margin-left: 10px;">â€¢</div>
            <div>×›×œ ××›×•× ×” ×“×•×¨×©×ª 5 ××˜×‘×¢×•×ª ×¢×‘×•×¨ 2 ×“×§×•×ª ××©×—×§</div>
        </div>
        
        <div style="margin-top: 30px; color: #FFFF00; font-size: 26px; text-shadow: 0 0 10px #FFFF00; text-align: center;">
            ×–×” ×”×–××Ÿ ×œ×©×—×§! ×‘×”×¦×œ×—×”
        </div>
    `;
    
    // ×›×¤×ª×•×¨ ×”×ª×—×œ×” - ×’×“×•×œ ×™×•×ª×¨
    const startButton = document.createElement('button');
    startButton.textContent = '×”×ª×—×œ!';
    startButton.style.backgroundColor = '#FF0000'; // ××“×•× × ×™××•×Ÿ
    startButton.style.color = 'white';
    startButton.style.border = 'none';
    startButton.style.borderRadius = '10px';
    startButton.style.padding = '20px 50px'; // ×’×“×•×œ ×™×•×ª×¨
    startButton.style.fontSize = '24px'; // ×’×•×¤×Ÿ ×’×“×•×œ ×™×•×ª×¨
    startButton.style.fontWeight = 'bold';
    startButton.style.cursor = 'pointer';
    startButton.style.fontFamily = "'Press Start 2P', 'Courier New', monospace";
    startButton.style.boxShadow = '0 0 10px #FF0000, 0 0 20px #FF0000';
    startButton.style.position = 'relative';
    startButton.style.overflow = 'hidden';
    startButton.style.transition = 'transform 0.2s, box-shadow 0.3s';
    startButton.style.margin = '0 auto'; // ××¨×›×•×–
    startButton.style.display = 'block'; // ×”×¦×’×” ×›×‘×œ×•×§ ×œ××¤×©×¨ ××¨×›×•×–
    
    // ×× ×™××¦×™×™×ª ×”×‘×”×•×‘ ×œ×›×¤×ª×•×¨
    startButton.style.animation = 'buttonPulse 1.5s infinite alternate';
    
    // ××¤×§×˜ ××¢×‘×¨ ×¢×›×‘×¨ ×¢×œ ×”×›×¤×ª×•×¨
    startButton.addEventListener('mouseover', () => {
        startButton.style.transform = 'scale(1.1)';
        startButton.style.boxShadow = '0 0 15px #FF0000, 0 0 30px #FF0000';
    });
    
    startButton.addEventListener('mouseout', () => {
        startButton.style.transform = 'scale(1)';
        startButton.style.boxShadow = '0 0 10px #FF0000, 0 0 20px #FF0000';
    });
    
    // ×¡×’×™×¨×ª ×”××•×“××œ ×‘×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨
    startButton.addEventListener('click', () => {
    modal.style.animation = 'fadeOut 0.5s forwards';
    
    // ×™×¦×™×¨×ª ××™×¨×•×¢ custom ×œ×”×•×“×¢×” ×¢×œ ×¡×’×™×¨×ª ××•×“×œ ×”×”×¡×‘×¨
    document.dispatchEvent(new Event('welcomeModalClosed'));
    
    setTimeout(() => {
        document.body.removeChild(modal);
        // ×”×ª×—×œ×ª ××•×–×™×§×ª ×”×¨×§×¢ ××—×¨×™ ×¡×’×™×¨×ª ×”××•×“××œ
        if (window.backgroundMusic) {
            window.backgroundMusic.play();
        }
        
        // ×”×¤×¢×œ×ª ×”×©×œ×™×˜×” ××—×“×© ××—×¨×™ ×©×”××•×“××œ × ×¡×’×¨
        if (controls) {
            controls.enabled = true;
        }
    }, 500);
});
    // ×”×•×¡×¤×ª ×¡×’× ×•×Ÿ ×× ×™××¦×™×” ××©×•×¤×¨
    const style = document.createElement('style');
    style.textContent = `
        @keyframes neonFlicker {
            0%, 19%, 21%, 23%, 25%, 54%, 56%, 100% {
                box-shadow: 0 0 20px #39ff14, 0 0 30px #39ff14, inset 0 0 15px rgba(57, 255, 20, 0.5);
                border-color: #39ff14;
            }
            20%, 24%, 55% {
                box-shadow: none;
                border-color: #555;
            }
        }
        @keyframes buttonPulse {
            0% {
                box-shadow: 0 0 10px #FF0000, 0 0 20px #FF0000;
            }
            100% {
                box-shadow: 0 0 15px #FF0000, 0 0 30px #FF0000, 0 0 50px #FF0000;
            }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        @font-face {
            font-family: 'Press Start 2P';
            src: url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        }
    `;
    
    // ×”×•×¡×¤×ª ×’×•×¤×Ÿ ×¨×˜×¨×•
    const fontLink = document.createElement('link');
    fontLink.rel = 'stylesheet';
    fontLink.href = 'https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap';
    document.head.appendChild(fontLink);
    
    // ×”×¨×›×‘×ª ×”××•×“××œ
    modalContent.appendChild(title);
    modalContent.appendChild(content);
    modalContent.appendChild(startButton);
    modal.appendChild(modalContent);
    document.head.appendChild(style);
    
    // ×”×•×¡×¤×ª ××¤×§×˜ ×¨×˜×¨×• ×©×œ ×§×•×•×™ ×¡×¨×™×§×”
    const scanlines = document.createElement('div');
    scanlines.style.position = 'absolute';
    scanlines.style.top = '0';
    scanlines.style.left = '0';
    scanlines.style.width = '100%';
    scanlines.style.height = '100%';
    scanlines.style.backgroundImage = 'linear-gradient(rgba(0, 0, 0, 0.1) 50%, rgba(0, 0, 0, 0.3) 50%)';
    scanlines.style.backgroundSize = '100% 4px';
    scanlines.style.pointerEvents = 'none';
    scanlines.style.zIndex = '1001';
    modal.appendChild(scanlines);
    
    // ×”×•×¡×¤×ª ×”××•×“××œ ×œ×“×£
    document.body.appendChild(modal);
    
    // ×¢×¦×™×¨×ª ××•×–×™×§×ª ×”×¨×§×¢ ×‘×–××Ÿ ×©×”××•×“××œ ×¤×ª×•×—
    if (window.backgroundMusic) {
        window.backgroundMusic.pause();
    }
};
        // ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×¢× ×—×œ×§×™×§×™ ×¢×©×Ÿ ×¡×’×•×œ
// ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×¢× ×—×œ×§×™×§×™ ×¢×©×Ÿ ×¡×’×•×œ
const createPortalEffect = () => {
    // ×™×¦×™×¨×ª ×’×™××•××˜×¨×™×” ×œ×—×œ×§×™×§×™×
    const particleCount = 500;
    const particleGeometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    
    // ×”×’×“×¨×ª ×¢×©×Ÿ ×‘××¢×’×œ ×¡×‘×™×‘ × ×§×•×“×ª ×”×¤×•×¨×˜×œ
    for (let i = 0; i < particleCount; i++) {
        // ××™×§×•× ××§×¨××™ ×‘×ª×•×š ×¡×¤×™×¨×”
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * portalRadius;
        const height = Math.random() * 5; // ×’×•×‘×” ×”×—×œ×§×™×§×™×
        
        // ×”×•×¡×¤×ª ×¨× ×“×•××™×•×ª ×§×˜× ×” ×œ××™×§×•×
        positions[i * 3] = specialPortalPoint.x + Math.cos(angle) * radius;
        positions[i * 3 + 1] = specialPortalPoint.y + height;
        positions[i * 3 + 2] = specialPortalPoint.z + Math.sin(angle) * radius;
        
        // ×¦×‘×¢ ×¡×’×•×œ ×¢× ×•×¨×™××¦×™×•×ª ×§×œ×•×ª
        colors[i * 3] = 0.5 + Math.random() * 0.2; // ××“×•×
        colors[i * 3 + 1] = 0; // ×™×¨×•×§
        colors[i * 3 + 2] = 0.8 + Math.random() * 0.2; // ×›×—×•×œ
    }
    
    particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    // ×™×¦×™×¨×ª ××˜×¨×™××œ ×œ×—×œ×§×™×§×™× ×¢× ×¡×•×’ ×¢×¨×‘×•×‘ (Blending) ××ª××™× ×œ×¢×©×Ÿ
    const particleMaterial = new THREE.PointsMaterial({
        size: 0.4,
        transparent: true,
        opacity: 0.6,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
        sizeAttenuation: true
    });
    
    // ×™×¦×™×¨×ª ×”××¢×¨×›×ª ×—×œ×§×™×§×™×
    portalParticles = new THREE.Points(particleGeometry, particleMaterial);
    
    // ×”×¤×•×¨×˜×œ ××ª×—×™×œ ×›×‘×œ×ª×™ × ×¨××”
    portalParticles.visible = false; // ×¤×•×¨×˜×œ ×œ× × ×¨××” ×‘×”×ª×—×œ×”
    
    scene.add(portalParticles);
    
    // ×”×•×¡×¤×ª ××•×¨ × ×§×•×“×ª×™ ×¡×’×•×œ ×‘××–×•×¨ ×”×¤×•×¨×˜×œ
    const portalLight = new THREE.PointLight(0x9932CC, 1, 10);
    portalLight.position.copy(specialPortalPoint);
    portalLight.position.y += 1.5; // ×”×¨××ª ×”××•×¨ ××¢×˜
    
    // ×”××•×¨ ×’× ×œ× × ×¨××” ×‘×”×ª×—×œ×”
    portalLight.visible = false;
    
    scene.add(portalLight);
    
    // ×©××™×¨×ª ×”××•×¨ ×œ×©×™××•×© ×××•×—×¨ ×™×•×ª×¨
    portalParticles.userData.light = portalLight;
};
        // ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª×¦×•×’×ª ××˜×‘×¢×•×ª
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª×¦×•×’×ª ××˜×‘×¢×•×ª - ×’×¨×¡×” ××©×•×¤×¨×ª ×•×’×“×•×œ×” ×™×•×ª×¨
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª×¦×•×’×ª ××˜×‘×¢×•×ª - ×’×¨×¡×” ××©×•×¤×¨×ª ×•×’×“×•×œ×” ×™×•×ª×¨
const addCoinsDisplay = () => {
    // ×™×¦×™×¨×ª ××™×›×œ ×œ××˜×‘×¢×•×ª
    const coinsContainer = document.createElement('div');
    coinsContainer.id = 'coins-display';
    
    // ×¢×™×¦×•×‘ ×”××™×›×œ - ×’×“×•×œ ×™×•×ª×¨
    coinsContainer.style.position = 'fixed';
    coinsContainer.style.top = '15px';
    coinsContainer.style.left = '110px'; // ×©×•× ×” ×-60px ×œ-110px ×œ×”×–×–×” ×™××™× ×”
    coinsContainer.style.zIndex = '100';
    coinsContainer.style.background = 'rgba(0, 0, 0, 0.7)'; // ×¨×§×¢ ×›×”×” ×™×•×ª×¨
    coinsContainer.style.color = 'white';
    coinsContainer.style.border = '2px solid gold'; // ×”×•×¡×¤×ª ××¡×’×¨×ª ×–×”×‘
    coinsContainer.style.borderRadius = '15px';
    coinsContainer.style.padding = '12px 20px';
    coinsContainer.style.fontSize = '18px'; // ×’×•×¤×Ÿ ×’×“×•×œ ×™×•×ª×¨
    coinsContainer.style.display = 'flex';
    coinsContainer.style.alignItems = 'center';
    coinsContainer.style.fontFamily = 'Arial, sans-serif';
    coinsContainer.style.direction = 'rtl'; // ×›×™×•×•×Ÿ ××™××™×Ÿ ×œ×©×××œ
    coinsContainer.style.boxShadow = '0 0 10px rgba(255, 215, 0, 0.5)'; // ×ª××•×¨×ª ×–×”×‘ ×¢×“×™× ×”
    
    // ×”×•×¡×¤×ª ×›×™×ª×•×‘ "×›××•×ª ××˜×‘×¢×•×ª ×©× ×©××¨×•:"
    const coinLabel = document.createElement('span');
    coinLabel.textContent = '×›××•×ª ××˜×‘×¢×•×ª ×©× ×©××¨×•: ';
    coinLabel.style.marginLeft = '10px';
    coinLabel.style.fontWeight = 'bold';
    
    // ×”×•×¡×¤×ª ××¡×¤×¨ ×”××˜×‘×¢×•×ª - ×’×“×•×œ ×™×•×ª×¨
    const coinCount = document.createElement('span');
    coinCount.id = 'coin-count';
    coinCount.textContent = playerCoins;
    coinCount.style.fontSize = '22px'; // ×’×•×¤×Ÿ ×’×“×•×œ ×™×•×ª×¨
    coinCount.style.fontWeight = 'bold';
    coinCount.style.color = 'gold'; // ×¦×‘×¢ ×–×”×‘ ×œ××¡×¤×¨
    
    // ×”×•×¡×¤×ª ×¡××œ ×”××˜×‘×¢ - ×’×“×•×œ ×™×•×ª×¨
    const coinSymbol = document.createElement('span');
    coinSymbol.innerHTML = 'ğŸª™';
    coinSymbol.style.fontSize = '26px'; // ×’×•×“×œ ×’×“×•×œ ×™×•×ª×¨
    coinSymbol.style.marginRight = '15px';
    coinSymbol.style.marginLeft = '10px';
    
    // ×”×¨×›×‘×ª ×”×ª×¦×•×’×” - ×”×¡×“×¨: ×¡××œ, ×›×™×ª×•×‘, ××¡×¤×¨
    coinsContainer.appendChild(coinSymbol);
    coinsContainer.appendChild(coinLabel);
    coinsContainer.appendChild(coinCount);
    
    // ×”×•×¡×¤×ª ×”×ª×¦×•×’×” ×œ×“×£
    document.body.appendChild(coinsContainer);
    
    // ×”×•×¡×¤×ª ×× ×™××¦×™×” ×§×œ×” ×œ××˜×‘×¢ ×‘×¢×ª ×˜×¢×™× ×”
    setTimeout(() => {
        coinSymbol.style.transition = 'transform 0.5s ease-in-out';
        coinSymbol.style.transform = 'scale(1.2)';
        setTimeout(() => {
            coinSymbol.style.transform = 'scale(1)';
        }, 500);
    }, 1000);
};
// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”××˜×‘×¢×•×ª
// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”××˜×‘×¢×•×ª
const updateCoins = (amount) => {
    // ×¢×“×›×•×Ÿ ×”××©×ª× ×” ×”×’×œ×•×‘×œ×™
    playerCoins = amount;
    
    // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
    const coinCountElement = document.getElementById('coin-count');
    if (coinCountElement) {
        coinCountElement.textContent = playerCoins;
    }
    
    // ×œ× ×©×•××¨×™× ××ª ×”××˜×‘×¢×•×ª ×‘-localStorage ×›×“×™ ×©×”× ×™××•×¤×¡×• ×‘×›×œ ×¨×™×¢× ×•×Ÿ
    // localStorage.setItem('playerCoins', playerCoins); - ×©×•×¨×” ×–×• ×”×•×¡×¨×”
    
    // ×‘×“×™×§×” ×× ×”××˜×‘×¢×•×ª ×”×’×™×¢×• ×œ-0
    if (playerCoins === 0) {
        showNoCoinsLeftModal();
    }
};
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××•×“××œ "× ×’××¨×• ×”××˜×‘×¢×•×ª"
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××•×“××œ "× ×’××¨×• ×”××˜×‘×¢×•×ª"
const showNoCoinsLeftModal = () => {
    // ×‘×“×™×§×” ×©×”××•×“××œ ×œ× ×§×™×™× ×›×‘×¨
    if (document.getElementById('no-coins-modal')) return;
    
    // ×™×¦×™×¨×ª ×”××•×“××œ
    const modal = document.createElement('div');
    modal.id = 'no-coins-modal';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
    modal.style.zIndex = '1001'; // ×’×‘×•×” ×™×•×ª×¨ ××©××¨ ×”××•×“××œ×™×
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    
    // ×™×¦×™×¨×ª ×ª×•×›×Ÿ ×”××•×“××œ
    const modalContent = document.createElement('div');
    modalContent.style.backgroundColor = '#000';
    modalContent.style.border = '5px solid #8A2BE2'; // ×¡×’×•×œ ×›×”×” ×›××• ×”×¤×•×¨×˜×œ
    modalContent.style.borderRadius = '15px';
    modalContent.style.padding = '40px';
    modalContent.style.maxWidth = '600px';
    modalContent.style.textAlign = 'center';
    modalContent.style.boxShadow = '0 0 30px rgba(138, 43, 226, 0.7)';
    modalContent.style.animation = 'pulse 2s infinite alternate';
    modalContent.style.direction = 'rtl';
    
    // ×”×•×¡×¤×ª ×¡×’× ×•×Ÿ ×× ×™××¦×™×”
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { box-shadow: 0 0 30px rgba(138, 43, 226, 0.7); }
            100% { box-shadow: 0 0 50px rgba(138, 43, 226, 0.9); }
        }
    `;
    document.head.appendChild(style);
    
    // ×›×•×ª×¨×ª
    const title = document.createElement('h1');
    title.textContent = '× ×’××¨×• ×œ×›× ×”××˜×‘×¢×•×ª!';
    title.style.color = '#8A2BE2'; // ×¡×’×•×œ
    title.style.fontSize = '36px';
    title.style.marginBottom = '20px';
    title.style.textShadow = '0 0 10px rgba(138, 43, 226, 0.7)';
    
    // ×”×•×“×¢×” - ×©×™× ×•×™ ×”×ª×•×›×Ÿ ×œ×¤×™ ×”×‘×§×©×”
    const message = document.createElement('p');
    message.textContent = '×—×¤×©×• ××ª ×”×“×¨×š ×”×—×•×¦×”';
    message.style.color = '#fff';
    message.style.fontSize = '22px';
    message.style.marginBottom = '30px';
    message.style.lineHeight = '1.5';
    
    // ×”×•×¡×¤×ª ××™×•×¨ ×©×œ ×¤×•×¨×˜×œ ×¡×’×•×œ
    const portalIcon = document.createElement('div');
    portalIcon.innerHTML = `
        <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="portalGrad" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                    <stop offset="0%" style="stop-color:#9932CC;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#4B0082;stop-opacity:0.7" />
                </radialGradient>
            </defs>
            <circle cx="50" cy="50" r="45" fill="url(#portalGrad)">
                <animate attributeName="r" values="45;48;45" dur="2s" repeatCount="indefinite" />
                <animate attributeName="opacity" values="0.8;1;0.8" dur="2s" repeatCount="indefinite" />
            </circle>
            <circle cx="50" cy="50" r="30" fill="#4B0082" opacity="0.7" />
        </svg>
    `;
    portalIcon.style.margin = '0 auto 30px auto';
    
    // ×›×¤×ª×•×¨ ×”××©×š
    const continueButton = document.createElement('button');
    continueButton.textContent = '×”××©×š';
    continueButton.style.backgroundColor = '#8A2BE2';
    continueButton.style.color = '#fff';
    continueButton.style.border = 'none';
    continueButton.style.borderRadius = '10px';
    continueButton.style.padding = '15px 40px';
    continueButton.style.fontSize = '20px';
    continueButton.style.fontWeight = 'bold';
    continueButton.style.cursor = 'pointer';
    continueButton.style.transition = 'all 0.3s';
    continueButton.style.boxShadow = '0 0 15px rgba(138, 43, 226, 0.5)';
    
    // ××¤×§×˜ hover ×œ×›×¤×ª×•×¨
    continueButton.addEventListener('mouseover', () => {
        continueButton.style.backgroundColor = '#9932CC';
        continueButton.style.transform = 'scale(1.05)';
        continueButton.style.boxShadow = '0 0 20px rgba(138, 43, 226, 0.8)';
    });
    
    continueButton.addEventListener('mouseout', () => {
        continueButton.style.backgroundColor = '#8A2BE2';
        continueButton.style.transform = 'scale(1)';
        continueButton.style.boxShadow = '0 0 15px rgba(138, 43, 226, 0.5)';
    });
    
    // ××™×¨×•×¢ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”××©×š
    continueButton.addEventListener('click', () => {
        // ×”×¡×¨×ª ×”××•×“××œ
        document.body.removeChild(modal);
        
        // ×”×¤×¢×œ×ª ×”×¤×•×¨×˜×œ ×”×•×•×¨×•×“
        activateMainPortal();
    });
    
    // ×”×¨×›×‘×ª ×”××•×“××œ
    modalContent.appendChild(title);
    modalContent.appendChild(message);
    modalContent.appendChild(portalIcon);
    modalContent.appendChild(continueButton);
    modal.appendChild(modalContent);
    
    // ×”×•×¡×¤×ª ×”××•×“××œ ×œ×“×£
    document.body.appendChild(modal);
    
    // ×”×©×”×™×™×ª ×”×©×œ×™×˜×” ×‘×–××Ÿ ×©×”××•×“××œ ×¤×ª×•×—
    if (controls) controls.enabled = false;
};
// ×¤×•× ×§×¦×™×” ×œ×”×¤×¢×œ×ª ×”×¤×•×¨×˜×œ ×”×•×•×¨×•×“
const activateMainPortal = () => {
    // ×”×’×“×¨×ª ×”×¤×•×¨×˜×œ ×›× ×¨××”
    mainPortalVisible = true;
    
    // ×”×—×–×¨×ª ×”×©×œ×™×˜×” ×œ××©×ª××©
    if (controls) controls.enabled = true;
    
    // ×¢×“×›×•×Ÿ × ×¨××•×ª ×”×—×œ×§×™×§×™× ×©×œ ×”×¤×•×¨×˜×œ
    if (portalParticles) {
        portalParticles.visible = true;
        
        // ×”×•×¡×¤×ª ××¤×§×˜ ×”×¤×¢×œ×” - ×’×™×“×•×œ ×”×—×œ×§×™×§×™×
        const originalSize = portalParticles.material.size;
        portalParticles.material.size = 0; // ××ª×—×™×œ ××’×•×“×œ 0
        
        // ×× ×™××¦×™×” ×œ×”×’×“×œ×ª ×”×—×œ×§×™×§×™×
        let growthTimer = 0;
        const growthInterval = setInterval(() => {
            growthTimer += 0.1;
            const newSize = originalSize * (1 - Math.exp(-growthTimer));
            portalParticles.material.size = newSize;
            
            if (growthTimer >= 3) {
                clearInterval(growthInterval);
                portalParticles.material.size = originalSize;
            }
        }, 50);
    }
    
    // ×”×•×¡×¤×ª ××¤×§×˜ ×§×•×œ×™ ×œ×”×¤×¢×œ×ª ×”×¤×•×¨×˜×œ
    try {
        const portalActivateSound = new Howl({
            src: ['audio/portal_activate.mp3'],
            volume: 0.7
        });
        portalActivateSound.play();
    } catch (e) {
        console.log('×œ× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ××¤×§×˜ ×§×•×œ×™:', e);
    }
    
    // ×”×•×¡×¤×ª ×”×ª×¨××” ×œ××©×ª××©
    showNotification('×¤×•×¨×˜×œ ×”××™×œ×•×˜ ×¤×¢×™×œ! ×’×© ××œ×™×• ×›×“×™ ×œ×¡×™×™× ××ª ×”××©×—×§×™×™×”');
};
// ×¤×•× ×§×¦×™×” ×œ×”×•×¨×“×ª ××˜×‘×¢
const spendCoin = () => {
    if (playerCoins >= 5) {
        // ××•×¨×™×“ 5 ××˜×‘×¢×•×ª ×‘×›×œ ×¤×¢×
        updateCoins(playerCoins - 5);
    } else {
        // ×”×•×“×¢×” ×›×©××™×Ÿ ××¡×¤×™×§ ××˜×‘×¢×•×ª
        alert('××™×Ÿ ××¡×¤×™×§ ××˜×‘×¢×•×ª! ×¦×¨×™×š ×œ×¤×—×•×ª 5 ××˜×‘×¢×•×ª ×›×“×™ ×œ×©×—×§.');
    }
};
        // ×× ×™××¦×™×” ×œ×¤×•×¨×˜×œ
// ×× ×™××¦×™×” ×œ×¤×•×¨×˜×œ
const animatePortal = () => {
    // ×× ×”×¤×•×¨×˜×œ ×œ× ×××•×¨ ×œ×”×™×•×ª × ×¨××” ××• ××™×Ÿ ×—×œ×§×™×§×™×, ×¦× ××”×¤×•× ×§×¦×™×”
    if (!mainPortalVisible || !portalParticles) return;
    
    // ×¢×“×›×•×Ÿ × ×¨××•×ª ×”×¤×•×¨×˜×œ ×•×”××•×¨ ×©×œ×• ×œ×¤×™ ×”×“×’×œ
    portalParticles.visible = mainPortalVisible;
    
    if (portalParticles.userData.light) {
        portalParticles.userData.light.visible = mainPortalVisible;
    }
    
    const positions = portalParticles.geometry.attributes.position.array;
    
    for (let i = 0; i < positions.length; i += 3) {
        // ×ª× ×•×¢×” ××§×¨××™×ª ×§×œ×”
        positions[i] += (Math.random() - 0.5) * 0.05;
        positions[i + 1] += Math.random() * 0.05; // ×ª× ×•×¢×” ×§×œ×” ×œ××¢×œ×”
        positions[i + 2] += (Math.random() - 0.5) * 0.05;
        
        // ×”×—×–×¨ ×—×œ×§×™×§×™× ×©×™×¦××• ×—×–×¨×” ×œ××–×•×¨ ×”×¤×•×¨×˜×œ
        const dx = positions[i] - specialPortalPoint.x;
        const dz = positions[i + 2] - specialPortalPoint.z;
        const distance = Math.sqrt(dx * dx + dz * dz);
        
        if (distance > portalRadius || positions[i + 1] > specialPortalPoint.y + 5) {
            // ×× ×”×—×œ×§×™×§ ×™×¦× ××”×’×‘×•×œ×•×ª, ×”×—×–×¨ ××•×ª×• ×œ××™×§×•× ×—×“×© ×‘×ª×•×š ×”×¤×•×¨×˜×œ
            const angle = Math.random() * Math.PI * 2;
            const radius = Math.random() * portalRadius * 0.7;
            
            positions[i] = specialPortalPoint.x + Math.cos(angle) * radius;
            positions[i + 1] = specialPortalPoint.y + Math.random() * 2.5;
            positions[i + 2] = specialPortalPoint.z + Math.sin(angle) * radius;
        }
    }
    
    portalParticles.geometry.attributes.position.needsUpdate = true;
};
        
        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××™×§×•× ×—×“×© ×•××¢×‘×¨ ×œ××¡×š ×”×‘×
// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××™×§×•× ×—×“×© ×•××¢×‘×¨ ×œ××¡×š ×”×‘×
const checkCustomLocationPoints = (position) => {
    // ×× ×”×¤×•×¨×˜×œ ×œ× ×××•×¨ ×œ×”×™×•×ª × ×¨××”, ×¦× ××”×¤×•× ×§×¦×™×”
    if (!mainPortalVisible) return false;
    
    // ×‘×“×™×§×ª ××¨×—×§ ×× ×§×•×“×ª ×”×¤×•×¨×˜×œ ×”××™×•×—×“×ª
    const distanceToPortal = position.distanceTo(specialPortalPoint);
    
    if (distanceToPortal < portalRadius / 2) { // ×›××©×¨ ×”×©×—×§×Ÿ ×‘×××ª ×§×¨×•×‘ ×œ×¤×•×¨×˜×œ
        // ××™×¤×•×¡ ××¦×‘ ×”×ª× ×•×¢×”
        movingForward = false;
        movingBackward = false;
        if (controls) {
            controls.moveForward = false;
            controls.moveBackward = false;
        }
        
        // ×¢×¦×™×¨×ª ×¦×œ×™×œ ×”×”×œ×™×›×” ×× ×¤×¢×™×œ
        if (isWalking && walkSound) {
            walkSound.pause();
            isWalking = false;
        }
        
        // ×‘××§×•× ××¢×‘×¨ ×™×©×™×¨, ×¤×ª×— ××ª ×¡×¨×˜×•×Ÿ ×”×¡×™×•×
        openEndingVideoModal();
        return true;
    }
    
    return false;
};
        
        // ×§×‘×•×¢ ×’×•×‘×” ×”×©×—×§×Ÿ ××¢×œ ×”××“××”
        
        
        // ×ª××•×¨×” ×•××¤×§×˜×™×
        const setupLighting = () => {
            // ××•×¨ ×¡×‘×™×‘×”
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            // ××•×¨ ×”×©××© ×”×¨××©×™
            const sunLight = new THREE.DirectionalLight(0xfffaf0, 1.0);
            sunLight.position.set(10, 20, 15);
            sunLight.castShadow = true;
            
            // ×”×’×“×¨×•×ª ×¦×œ ××™×›×•×ª×™×•×ª ×™×•×ª×¨
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 50;
            sunLight.shadow.camera.left = -20;
            sunLight.shadow.camera.right = 20;
            sunLight.shadow.camera.top = 20;
            sunLight.shadow.camera.bottom = -20;
            sunLight.shadow.bias = -0.0003;
            
            scene.add(sunLight);
            
            // × ×§×•×“×ª ××•×¨ ××©× ×™×ª ×œ×ª××•×¨×ª ××™×œ×•×™
            const fillLight = new THREE.DirectionalLight(0xc2d1ff, 0.5);
            fillLight.position.set(-10, 10, -10);
            scene.add(fillLight);
            
            // ××•×¨ × ×§×•×“×ª×™ ×¢×“×™×Ÿ ×‘××¨×›×– ×”×¡×¦× ×”
            const pointLight = new THREE.PointLight(0xffedbe, 0.5, 20);
            pointLight.position.set(0, 12, 0);
            scene.add(pointLight);
            
            // ×¢×¨×¤×œ ×œ×ª×—×•×©×ª ×¢×•××§
            scene.fog = new THREE.FogExp2(0x8eb5e0, 0.006); // ×”×§×˜× ×ª ×¢×¨×š ×”×¦×¤×™×¤×•×ª ×œ×’×•×‘×” ×”×’×“×•×œ ×™×•×ª×¨
        };
        
        // ×™×¦×™×¨×ª ×˜×§×¡×˜×•×¨×ª ×¨×¦×¤×” ×‘×¡×’× ×•×Ÿ ×›×‘×™×©
// ×™×¦×™×¨×ª ×˜×§×¡×˜×•×¨×ª ×¨×¦×¤×” ×‘×¡×’× ×•×Ÿ ×›×‘×™×© ×œ×œ× ×¡×™××•× ×™×
// ×™×¦×™×¨×ª ×˜×§×¡×˜×•×¨×ª ×¨×¦×¤×” ×‘×¡×’× ×•×Ÿ ×¨×—×•×‘ ×™×©×Ÿ ×¢× ××¨×¦×¤×•×ª ××œ×‘× ×™×•×ª ×‘×’×•×•×Ÿ ×—×•× ×›×”×”
const createRoadTexture = () => {
    const textureSize = 1024;
    const canvas = document.createElement('canvas');
    canvas.width = textureSize;
    canvas.height = textureSize;
    const ctx = canvas.getContext('2d');
    
    // ×¦×‘×¢ ×¨×§×¢ ×›×”×”
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ×™×¦×™×¨×ª ×“×¤×•×¡ ××©×‘×¦×•×ª ×©×—×•×¨-×œ×‘×Ÿ
    const tileSize = 16; // ×’×•×“×œ ×›×œ ××©×‘×¦×ª
    const numTiles = canvas.width / tileSize;
    
    for (let x = 0; x < numTiles; x++) {
        for (let y = 0; y < numTiles; y++) {
            // ×¦×‘×¢ ×”××©×‘×¦×ª - ×©×—×•×¨ ××• ×œ×‘×Ÿ ×œ×¡×™×¨×•×’×™×Ÿ
            const isWhite = (x + y) % 2 === 0;
            
            if (isWhite) {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
            } else {
                // ××©×‘×¦×•×ª ×©×—×•×¨×•×ª ×¢× ×’×•×•×Ÿ ××¢×˜ ××¤×•×¨ ×›×“×™ ×©×™×”×™×” × ×™×ª×Ÿ ×œ×¨××•×ª ××•×ª×Ÿ
                ctx.fillStyle = '#101010';
                ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
            }
        }
    }
    
    // ×”×•×¡×¤×ª ××¤×§×˜ ×”×©×ª×§×¤×•×ª ×¡×’×•×œ×”
    ctx.globalCompositeOperation = 'overlay';
    
    // ×™×¦×™×¨×ª ×’×¨×“×™×× ×˜ ×¡×’×•×œ
    const gradient = ctx.createRadialGradient(
        canvas.width/2, canvas.height/2, 0,
        canvas.width/2, canvas.height/2, canvas.width/2
    );
    gradient.addColorStop(0, 'rgba(180, 0, 255, 0.6)');
    gradient.addColorStop(0.5, 'rgba(150, 0, 200, 0.4)');
    gradient.addColorStop(1, 'rgba(100, 0, 150, 0.2)');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // ×”×•×¡×¤×ª ××¤×§×˜ ×”×©×ª×§×¤×•×ª/×‘×¨×§
    ctx.globalCompositeOperation = 'lighter';
    
    // ×”×•×¡×¤×ª × ×§×•×“×•×ª ×‘×¨×§ ×¢×œ ×”×¨×¦×¤×”
    for (let i = 0; i < 15; i++) {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height;
        const size = 100 + Math.random() * 150;
        
        const reflection = ctx.createRadialGradient(x, y, 0, x, y, size);
        reflection.addColorStop(0, 'rgba(255, 200, 255, 0.3)');
        reflection.addColorStop(0.5, 'rgba(180, 120, 220, 0.1)');
        reflection.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = reflection;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // ×—×–×¨×” ×œ××¦×‘ ×¦×™×•×¨ ×¨×’×™×œ
    ctx.globalCompositeOperation = 'source-over';
    
    // ×™×¦×™×¨×ª ×˜×§×¡×˜×•×¨×” ××”×§× ×‘×¡
    const texture = new THREE.CanvasTexture(canvas);
    texture.wrapS = THREE.RepeatWrapping;
    texture.wrapT = THREE.RepeatWrapping;
    texture.repeat.set(2, 2); // ×¤×—×•×ª ×—×–×¨×•×ª ×œ×¨×™×‘×•×¢×™× ×’×“×•×œ×™× ×™×•×ª×¨
    
    return texture;
};

// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×˜×§×¡×˜×•×¨×” ×œ×›×œ ××‘×Ÿ
const addStoneTexture = (ctx, x, y, width, height) => {
    // ×”×•×¡×¤×ª ××¨×§× ××—×•×¡×¤×¡ ×œ××‘×Ÿ
    for (let i = 0; i < width * height / 40; i++) {
        const px = x + Math.random() * width;
        const py = y + Math.random() * height;
        const size = Math.random() * 2 + 0.5;
        
        // ×¦×‘×¢ ××§×¨××™ ×œ×›×ª× - ×’×•×•×Ÿ ×©×œ ×—×•× ×›×”×”
        ctx.fillStyle = `rgba(45, 30, 20, ${Math.random() * 0.3})`;
        ctx.beginPath();
        ctx.arc(px, py, size, 0, Math.PI * 2);
        ctx.fill();
    }
};

// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×©×—×™×§×”, ×¡×“×§×™× ×•×›×ª××™× ×¢×œ ×”×¨×¦×¤×”
const addWearAndTear = (ctx, width, height, tileWidth, tileHeight, groutWidth) => {
    // ×”×•×¡×¤×ª ×¡×“×§×™× ××§×¨××™×™×
    for (let i = 0; i < 120; i++) {
        const x = Math.random() * width;
        const y = Math.random() * height;
        const length = 8 + Math.random() * 30;
        const angle = Math.random() * Math.PI * 2;
        
        ctx.strokeStyle = `rgba(30, 20, 15, ${Math.random() * 0.6 + 0.2})`;
        ctx.lineWidth = Math.random() * 1.5 + 0.5;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
        
        // ×¡×“×§ ××¤×•×ª×œ
        let currentX = x;
        let currentY = y;
        const segments = 2 + Math.floor(Math.random() * 3);
        const segmentLength = length / segments;
        
        for (let j = 0; j < segments; j++) {
            const segAngle = angle + (Math.random() * 0.5 - 0.25);
            currentX += Math.cos(segAngle) * segmentLength;
            currentY += Math.sin(segAngle) * segmentLength;
            ctx.lineTo(currentX, currentY);
        }
        
        ctx.stroke();
    }
    
    // ×”×•×¡×¤×ª ×›×ª××™× ×•×›×”×•×™×•×ª
    for (let i = 0; i < 300; i++) {
        const x = Math.random() * width;
        const y = Math.random() * height;
        const size = 5 + Math.random() * 15;
        
        // ×¦×‘×¢×™× ×©×•× ×™× ×œ×›×ª××™×
        let color;
        const type = Math.random();
        
        if (type < 0.6) {
            // ×›×ª× ×›×”×” ×™×•×ª×¨ (×©×—×™×§×”)
            color = `rgba(20, 15, 10, ${Math.random() * 0.3})`;
        } else if (type < 0.9) {
            // ×›×ª× ×—×•× ×›×”×” (×œ×›×œ×•×š)
            color = `rgba(40, 25, 15, ${Math.random() * 0.4})`;
        } else {
            // ×›×ª× ×—×•×-××“××“× (×—×œ×•×“×”)
            color = `rgba(60, 30, 20, ${Math.random() * 0.3})`;
        }
        
        const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // ×¦×™×•×¨ ×§×•×•×™ ×—×™×‘×•×¨ ×‘×™×Ÿ ×”××œ×‘× ×™× ×‘×¦×‘×¢ ×›×”×” ×™×•×ª×¨
    // ×§×•×•×™× ×× ×›×™×™×
    for (let x = 0; x < width; x += tileWidth) {
        ctx.strokeStyle = `rgba(15, 10, 5, 0.9)`; // ×—×™×‘×•×¨×™× ×›×”×™× ×™×•×ª×¨
        ctx.lineWidth = groutWidth;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }
    
    // ×§×•×•×™× ××•×¤×§×™×™×
    for (let y = 0; y < height; y += tileHeight) {
        ctx.strokeStyle = `rgba(15, 10, 5, 0.9)`;
        ctx.lineWidth = groutWidth;
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
    
    // ×”×•×¡×¤×ª ××¤×§×˜ ×¨×˜×™×‘×•×ª ××§×¨××™
    for (let i = 0; i < 15; i++) {
        const x = Math.random() * width;
        const y = Math.random() * height;
        const size = 30 + Math.random() * 80;
        
        const gradient = ctx.createRadialGradient(x, y, 0, x, y, size);
        gradient.addColorStop(0, 'rgba(25, 15, 10, 0.3)');
        gradient.addColorStop(0.7, 'rgba(25, 15, 10, 0.1)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // ×”×•×¡×¤×ª ××¢×˜ ×‘×¨×§ ×œ××‘× ×™× ×‘× ×§×•×“×•×ª ××¡×•×™××•×ª (×›××• ×©×™×© ×œ×¤×¢××™× ×‘×¨×¦×¤×•×ª ×™×©× ×•×ª)
    for (let i = 0; i < 100; i++) {
        const x = Math.random() * width;
        const y = Math.random() * height;
        const size = 1 + Math.random() * 3;
        
        ctx.fillStyle = `rgba(100, 80, 60, ${Math.random() * 0.2 + 0.1})`;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
    }
};
        
        // ×™×¦×™×¨×ª ×§×¨×§×¢ ×©×˜×•×—×” ×‘×¡×’× ×•×Ÿ ×›×‘×™×©
// ×™×¦×™×¨×ª ×§×¨×§×¢ ×©×˜×•×—×” ×‘×¡×’× ×•×Ÿ ×›×‘×™×©
// ×™×¦×™×¨×ª ×§×¨×§×¢ ×©×˜×•×—×” ×‘×¦×•×¨×ª ×¨×™×‘×•×¢ ×××™×ª×™
const createFlatRoadGround = () => {
    // ×™×¦×™×¨×ª ×¨×™×‘×•×¢ ×××™×ª×™ ×›×¨×¦×¤×”
    const boxWidth = 200;
    const boxDepth = 200;
    const boxHeight = 1; // ×’×•×‘×” ×“×§ ×××•×“
    
    // ×©×™××•×© ×‘-BoxGeometry ×©×™×•×¦×¨×ª ×¨×™×‘×•×¢ ××•×©×œ×
    const geometry = new THREE.BoxGeometry(boxWidth, boxHeight, boxDepth);
    
    // ×™×¦×™×¨×ª ×”××˜×¨×™××œ ×¢× ×˜×§×¡×˜×•×¨×ª ×›×‘×™×©
    const roadTexture = createRoadTexture();
    
    // ×”×’×“×¨×ª ××¢×¨×š ×©×œ ××˜×¨×™××œ×™× ×œ×›×œ ×¤××” ×©×œ ×”×§×•×¤×¡×”
    const materials = [
        new THREE.MeshStandardMaterial({ color: 0x555555 }), // ×¦×“ ×™××™×Ÿ
        new THREE.MeshStandardMaterial({ color: 0x555555 }), // ×¦×“ ×©×××œ
        new THREE.MeshStandardMaterial({ map: roadTexture, roughness: 0.9, metalness: 0.1 }), // ×œ××¢×œ×” (×”×¨×¦×¤×” ×¢×¦××”)
        new THREE.MeshStandardMaterial({ color: 0x555555 }), // ×œ××˜×”
        new THREE.MeshStandardMaterial({ color: 0x555555 }), // ×—×–×™×ª
        new THREE.MeshStandardMaterial({ color: 0x555555 })  // ×’×‘
    ];
    
    ground = new THREE.Mesh(geometry, materials);
    
    // ××™×§×•× ×”×¨×¦×¤×” ×‘×’×•×‘×” 0
    ground.position.y = -0.5; // ×—×¦×™ ××”×’×•×‘×” ×›×“×™ ×©×”×—×œ×§ ×”×¢×œ×™×•×Ÿ ×™×”×™×” ×‘×“×™×•×§ ×‘×’×•×‘×” 0
    ground.receiveShadow = true;
    scene.add(ground);
    
    return ground;
};
        
        // ×™×¦×™×¨×ª ×§×•×œ×™×“×¨×™× ×œ×§×™×¨×•×ª ×”×× ×”×¨×”
        
        // ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×¢× ×§×™×¨×•×ª ×”×× ×”×¨×”

        




        // ×™×¦×™×¨×ª ××¢×¨×›×ª ×©×œ×™×˜×” ×‘×’×•×£ ×¨××©×•×Ÿ
        const setupFirstPersonControls = () => {
    controls = new THREE.FirstPersonControls(camera, renderer.domElement);
    controls.movementSpeed = 4;
    controls.lookSpeed = 0.03;
    controls.lookVertical = true;
    controls.constrainVertical = true;
    controls.verticalMin = Math.PI / 6;
    controls.verticalMax = Math.PI / 1.8;
    
    // ×©×™× ×œ×‘ ×©×‘×”×ª×—×œ×” ×”×©×œ×™×˜×” ××•×©×‘×ª×ª
    controls.enabled = false;
            // ×”×’×“×¨×ª ××–×•×¨ ××ª ×‘×§×¦×•×•×ª ×”××¡×š ×©×™×¢×¦×•×¨ ××ª ×”×ª×–×•×–×”
            const boundaryThreshold = 0.05; // 5% ××”×§×¦×” (95% ××”××¡×š ×¤×¢×™×œ)
            
            // ×”××–× ×” ×œ×ª×–×•×–×ª ×”×¢×›×‘×¨
            document.addEventListener('mousemove', (e) => {
                const mouseX = e.clientX / window.innerWidth;
                const mouseY = e.clientY / window.innerHeight;
                
                // ×‘×“×™×§×” ×× ×”×¢×›×‘×¨ × ××¦× ×‘××–×•×¨ ×”××ª (×§×¨×•×‘ ×œ×§×¦×•×•×ª)
                const isNearLeftEdge = mouseX < boundaryThreshold;
                const isNearRightEdge = mouseX > (1 - boundaryThreshold);
                const isNearTopEdge = mouseY < boundaryThreshold;
                const isNearBottomEdge = mouseY > (1 - boundaryThreshold);
                
                // ×¢×¦×™×¨×ª ×”×ª×–×•×–×” ×× ×”×¢×›×‘×¨ ×‘×§×¦×•×•×ª
                if (isNearLeftEdge || isNearRightEdge || isNearTopEdge || isNearBottomEdge) {
                    if (controls.activeLook !== false) {
                        controls.activeLook = false;
                    }
                } else {
                    if (controls.activeLook !== true) {
                        controls.activeLook = true;
                    }
                }
            });
        };
        
        // ×˜×¢×™× ×ª ××•×“×œ GLB (×¨×§ tunnel.glb)
        const loadTunnelModel = () => {
    const loader = new THREE.GLTFLoader();
    
    // ×”×¦×’×ª ×”×•×“×¢×ª ×˜×¢×™× ×”
    document.getElementById('loading').style.display = 'block';
    document.getElementById('loading').textContent = '×˜×•×¢×Ÿ ××ª ×”××•×“×œ...';
    
    loader.load(
        '3d/games.glb',
        (gltf) => {
            const model = gltf.scene;
            
            // ×”×’×“×¨×ª ×¦×œ×œ×™× ×œ×›×œ ×”××©×™× ×‘××•×“×œ
            model.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                    
                    // ×”×™×¤×•×š ×”× ×•×¨××œ×™× ×× ×–×” ×œ× ××•×“×œ ×©×”×•×¢×œ×” ×¢×œ-×™×“×™ ×”××©×ª××©

                }
            });
            
            // ×©××™×¨×” ×¢×œ ×”×¡×§×™×™×œ ×•×”××™×§×•× ×”××§×•×¨×™×™× ×©×œ ×”××•×“×œ
            model.scale.set(2, 3, 2);
            model.position.set(0, 8, 0); // ×©××™×¨×” ×¢×œ ×”×’×•×‘×” ×”××§×•×¨×™
            
            // ×©××™×¨×ª ×”××•×“×œ ×œ××©×ª× ×” ×”×’×œ×•×‘×œ×™
            worldModel = model;
            
            scene.add(model);
            document.getElementById('loading').style.display = 'none';
            isLoaded = true;
        },
        (xhr) => {
            const percentComplete = (xhr.loaded / xhr.total) * 100;
            document.getElementById('loading').textContent = 
                `×˜×•×¢×Ÿ ××ª ×”××•×“×œ... ${Math.round(percentComplete)}%`;
        },
        (error) => {
            console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”××•×“×œ:', error);
            document.getElementById('loading').style.display = 'none';
            isLoaded = true;
        }
    );
};
        
        // ×—×–×¨×” ×œ×¢×•×œ×
        document.getElementById('back-button').addEventListener('click', () => {
            document.getElementById('next-screen').style.display = 'none';
            controls.enabled = true; // ×”×¤×¢×œ×ª ×”×©×œ×™×˜×” ××—×“×©
        });
        
        // ×”×ª×××ª ×’×•×“×œ ×”×—×œ×•×Ÿ
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            if (controls) {
                controls.handleResize();
            }
        });
        
// ×”×’×“×¨×ª ×¡××•× ×“ ×œ×”×œ×™×›×”
const setupWalkSound = () => {
    // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×¡××•× ×“ ×œ×”×œ×™×›×” ×¢× ×”××•×¤×¦×™×” ×œ×”×¤×¢×œ×” ×—×•×–×¨×ª (loop)
    walkSound = new Howl({
        src: ['audio/walk.mp3'],
        loop: true,
        volume: 0.7
    });

    
    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ××™×¨×•×¢ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×¢×›×‘×¨
    document.addEventListener('mousedown', (e) => {
        // ×‘×“×™×§×” ×× ×œ×—×¥ ×›×¤×ª×•×¨ ×©×××œ×™ (0) ×•×œ× ×‘×ª×•×š ××•×“××œ ×¤×ª×•×—
        if (e.button === 0 && !isWalking && !document.getElementById('game-modal')?.classList.contains('show')) {
            walkSound.play();
            isWalking = true;
        }
    });
    
    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ××™×¨×•×¢ ×©×—×¨×•×¨ ×›×¤×ª×•×¨ ×”×¢×›×‘×¨
    document.addEventListener('mouseup', (e) => {
        // ×‘×“×™×§×” ×× ×©×•×—×¨×¨ ×›×¤×ª×•×¨ ×©×××œ×™ (0)
        if (e.button === 0 && isWalking) {
            walkSound.pause();
            isWalking = false;
        }
    });
    
    // ×× ×™×¢×ª ×ª×¤×¨×™×˜ ×§×œ×™×§ ×™×× ×™
    document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
    });
    
    // ××™×¤×•×¡ ××¦×‘ ×”×”×œ×™×›×” ×›×©×”×“×£ × ×˜×¢×Ÿ ××—×“×©
    window.addEventListener('load', () => {
        isWalking = false;
    });
};

        // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××•×“×œ ×”××›×•× ×”
const loadMachineModel = () => {
    const loader = new THREE.GLTFLoader();
    
    loader.load(
        '3d/machine.glb',
        (gltf) => {
            const model = gltf.scene;
            
            // ×”×’×“×¨×ª ×¦×œ×œ×™× ×œ×›×œ ×”××©×™× ×‘××•×“×œ
            model.traverse((node) => {
                if (node.isMesh) {
                    node.castShadow = true;
                    node.receiveShadow = true;
                }
            });
            
            // ××™×§×•× ×”××•×“×œ ×‘×§×•××•×¨×“×™× ×˜×•×ª ×”××‘×•×§×©×•×ª
            model.position.set(-39, 1.6, 18.37);
            
            // ×¡×§×™×™×œ ×”××•×“×œ - ××¤×©×¨ ×œ×”×ª××™× ×œ×¤×™ ×”×¦×•×¨×š
            model.scale.set(1, 1, 1);
            
            // ×”×•×¡×¤×ª ×”××•×“×œ ×œ×¡×¦× ×”
            scene.add(model);
            console.log('Machine model loaded successfully');
        },
        (xhr) => {
            console.log(`Machine model loading: ${(xhr.loaded / xhr.total) * 100}% loaded`);
        },
        (error) => {
            console.error('Error loading machine model:', error);
        }
    );
};
        // ××ª×—×•×œ ×”×¡×¦× ×”
// ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ××•×“××œ ×¡×¨×˜×•×Ÿ ×”×¡×™×•×
const openEndingVideoModal = () => {
    const modal = document.getElementById('ending-video-modal');
    const video = document.getElementById('ending-video');
    
    if (!modal || !video) {
        console.error('×œ× × ××¦××• ××œ×× ×˜×™ ×”××•×“××œ ××• ×”×¡×¨×˜×•×Ÿ');
        window.location.href = 'future.html'; // ××¢×‘×¨ ×—×™×¨×•× ×× ×”××•×“××œ ×œ× × ××¦×
        return;
    }
    
    // ××™×¤×•×¡ ××¦×‘ ×”×ª× ×•×¢×”
    movingForward = false;
    movingBackward = false;
    if (controls) {
        controls.moveForward = false;
        controls.moveBackward = false;
        controls.enabled = false;
    }
    
    // ×¢×¦×™×¨×ª ×”××•×–×™×§×” ×× ××ª× ×’× ×ª
    if (window.backgroundMusic && window.backgroundMusic.playing()) {
        window.backgroundMusic.pause();
    }
    
    // ×¢×¦×™×¨×ª ×¦×œ×™×œ ×”×”×œ×™×›×” ×× ×¤×¢×™×œ
    if (isWalking && walkSound) {
        walkSound.pause();
        isWalking = false;
    }
    
    // ×”×¦×’×ª ×”××•×“××œ
    modal.style.display = 'flex';
    
    // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×¡×™×•× ×”×¡×¨×˜×•×Ÿ
    video.addEventListener('ended', () => {
        // ××¢×‘×¨ ×œ×“×£ ×”×‘× ×›×©×”×¡×¨×˜×•×Ÿ ××¡×ª×™×™×
        window.location.href = 'future.html';
    });
    
    // ×”×¤×¢×œ×ª ×”×¡×¨×˜×•×Ÿ
    video.play().catch(err => {
        console.error('×©×’×™××” ×‘×”×¤×¢×œ×ª ×”×¡×¨×˜×•×Ÿ:', err);
        // ×× ×”×¤×¢×œ×ª ×”×¡×¨×˜×•×Ÿ × ×›×©×œ×”, ×¢×‘×•×¨ ×œ×“×£ ×”×‘×
        setTimeout(() => {
            window.location.href = 'future.html';
        }, 1000);
    });
};
const init = () => {
    // ×”×’×“×¨×ª ×ª××•×¨×”
    setupLighting();
    
    // ××™×§×•× ×”××¦×œ××” ×•×”×¡×™×‘×•×‘
    camera.rotation.set(
        THREE.MathUtils.degToRad(100),
        THREE.MathUtils.degToRad(220),
        0
    );
    
    // ×™×¦×™×¨×ª ×§×¨×§×¢ ×©×˜×•×—×”
    createFlatRoadGround();
    
    // ×”×’×“×¨×ª ×©×œ×™×˜×” ×‘×’×•×£ ×¨××©×•×Ÿ
    setupFirstPersonControls();
    
    // ×”×’×“×¨×ª ×¡××•× ×“ ×œ×”×œ×™×›×”
    setupWalkSound();
    
    // ×”×’×“×¨×ª ×‘×§×¨×•×ª ×ª× ×•×¢×” - ×”×•×¡×¤×ª ×”×§×¨×™××” ×”×—×“×©×”
    setupMovementControls();
    
    // ×”×’×“×¨×ª ××•×–×™×§×ª ×¨×§×¢
    setupBackgroundMusic();
    
    // ×”×•×¡×¤×ª ×ª××•× ×•×ª ××¢×œ ×”××›×•× ×•×ª
    addMachineImages();
    
    // ×™×¦×™×¨×ª ××¤×§×˜ ×¤×•×¨×˜×œ ×”×¢×™×§×¨×™
    createPortalEffect();
    
    // ×”×•×¡×¤×ª ×¤×•×¨×˜×œ×™× ×œ××›×•× ×•×ª ×”××©×—×§
    addGameMachinePortals();
    
    // ×”×•×¡×¤×ª ×ª×¦×•×’×ª ××˜×‘×¢×•×ª
    addCoinsDisplay();
    
    // ××™×¤×•×¡ ×”××˜×‘×¢×•×ª ×œ-20 ×‘×›×œ ×¤×¢× ×©×”×¢××•×“ × ×˜×¢×Ÿ
    playerCoins = 20;
    updateCoins(20);
    
    // ××™×¤×•×¡ ×¨×©×™××ª ×”××©×—×§×™× ×©×‘×™×§×¨×ª ×‘×”×
    visitedGames = [];
    
    // ×”×¡×¨×ª × ×ª×•× ×™× ×§×•×“××™× ××”×œ×•×§×œ ×¡×˜×•×¨×’'
    localStorage.removeItem('playerCoins');
    localStorage.removeItem('visitedGames');
    
    // ××™×§×•× ×”×©×—×§×Ÿ ×‘× ×§×•×“×ª ×”×”×ª×—×œ×”
    camera.position.set(-17.24, PLAYER_HEIGHT, -0.94);
    
    // ×˜×¢×™× ×ª ××•×“×œ GLB
    loadTunnelModel();
    loadDJModel();
    loadMultipleMachines();
    
    // ×”×’×“×¨×ª ×—×œ×•× ×™×ª ×”××©×™××”
    setupMissionPopup();
    
    // ×˜×™×™××¨ ×œ×˜×¢×™× ×”
    setTimeout(() => {
        if (document.getElementById('loading').style.display !== 'none') {
            document.getElementById('loading').style.display = 'none';
            isLoaded = true;
        }
    }, 1000);
    
    // ×”×ª×—×œ×ª ×œ×•×œ××ª ×”×× ×™××¦×™×”
    animate();
    
    // ×”×¦×’×ª ××•×“×œ ×”×¡×¨×˜×•×Ÿ
    setupVideoModal();
};

const addModalStyles = () => {
    const style = document.createElement('style');
    style.textContent = `
        #game-modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }
        #game-modal.show {
            opacity: 1;
        }
        #game-modal .modal-content {
            transition: transform 0.3s ease-in-out;
            transform: translateY(20px);
        }
        #game-modal.show .modal-content {
            transform: translateY(0);
        }
        
        /* ×× ×™××¦×™×” ×œ×›×¤×ª×•×¨ ×”×¡×’×™×¨×” */
        #game-modal span:hover {
            color: #ff00ff;
            transform: scale(1.1);
            transition: all 0.2s ease-in-out;
        }
        
        /* ×× ×™×¢×ª ×’×œ×™×œ×” ×›×©×”××•×“××œ ×¤×ª×•×— */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
    `;
    document.head.appendChild(style);
};
        // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××¡×¤×¨ ××›×•× ×•×ª ×‘××™×§×•××™× ×©×•× ×™×
// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××¡×¤×¨ ××›×•× ×•×ª ×‘××™×§×•××™× ×©×•× ×™×
// ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ××¡×¤×¨ ××›×•× ×•×ª ×‘××™×§×•××™× ×•×‘×–×•×•×™×•×ª ×§×‘×•×¢×•×ª
const loadMultipleMachines = () => {
    const loader = new THREE.GLTFLoader();
    
    // ××¢×¨×š ×©×œ ××™×§×•××™× ×•×–×•×•×™×•×ª ×œ××›×•× ×•×ª ×”×©×•× ×•×ª
    const machinePositions = [
        { x: -7.11, y: 2, z: 11.75, rotation: Math.PI * 1.0 },   // ××›×•× ×” 1 - 90 ××¢×œ×•×ª
        { x: 0.74, y: 2, z: 15.23, rotation: Math.PI },         // ××›×•× ×” 2 - 180 ××¢×œ×•×ª
        { x: 8.09, y: 2, z: 13.59, rotation: Math.PI * 1.3 },   // ××›×•× ×” 3 - 270 ××¢×œ×•×ª
        { x: 15.77, y: 2, z: 7.09, rotation: Math.PI * 1.4 },               // ××›×•× ×” 4 - 0 ××¢×œ×•×ª
        { x: 16, y: 2, z: 0.01, rotation: Math.PI * 1.8 },     // ××›×•× ×” 5 - 45 ××¢×œ×•×ª
        { x: 10.95, y: 2, z: -5.55, rotation: Math.PI * 1.75 }  // ××›×•× ×” 6 - 315 ××¢×œ×•×ª
    ];
    
    // ×˜×¢×™× ×ª ×”××•×“×œ ×¤×¢× ××—×ª ×•×™×¦×™×¨×ª ×¢×•×ª×§×™×
    loader.load(
        '3d/machine.glb',
        (gltf) => {
            const originalModel = gltf.scene;
            
            // ×˜×™×¤×•×œ ×‘×›×œ ×”××›×•× ×•×ª ×œ×¤×™ ××¢×¨×š ×”××™×§×•××™×
            machinePositions.forEach((position, index) => {
                // ×™×¦×™×¨×ª ×¢×•×ª×§ ×—×“×© ×©×œ ×”××•×“×œ ×œ×›×œ ××›×•× ×”
                const model = originalModel.clone();
                
                // ×”×’×“×¨×ª ×¦×œ×œ×™× ×œ×›×œ ×”××©×™× ×‘××•×“×œ
                model.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
                
                // ××™×§×•× ×”××•×“×œ ×œ×¤×™ ×”××™×§×•× ×”×¡×¤×¦×™×¤×™ ××”××¢×¨×š
                model.position.set(position.x, position.y, position.z);
                
                // ×¡×™×‘×•×‘ ×”××›×•× ×” ×œ×¤×™ ×”×–×•×•×™×ª ×©×”×•×’×“×¨×” (×¡×‘×™×‘ ×¦×™×¨ ×”-Y)
                model.rotation.y = position.rotation;
                
                // ×¡×§×™×™×œ ×”××•×“×œ - ××—×™×“ ×œ×›×œ ×”××›×•× ×•×ª
                model.scale.set(2, 2, 2);
                
                // ×”×•×¡×¤×ª ×”××•×“×œ ×œ×¡×¦× ×”
                scene.add(model);
                console.log(`Machine ${index + 1} loaded successfully at position`, position);
            });
        },
        (xhr) => {
            console.log(`Machines loading: ${(xhr.loaded / xhr.total) * 100}% loaded`);
        },
        (error) => {
            console.error('Error loading machine models:', error);
        }
    );
};
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª××•× ×” ×¢×œ ×”×§×™×¨
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ××¡×¤×¨ ×ª××•× ×•×ª ××¢×œ ×”××›×•× ×•×ª
const addMachineImages = () => {
    // ××¢×¨×š ×©×œ ××™×§×•××™×, ×¡×™×‘×•×‘×™× ×•×©××•×ª ×§×‘×¦×™ ×”×ª××•× ×•×ª
    const imagePositions = [
        { x: -7.11, y: 7.5, z: 11.75, rotation: Math.PI * 0.0, image: 'img/flagDave.jpg', flipSide: true },
        { x: 0.74, y: 7.5, z: 15.23, rotation: Math.PI * 0.0, image: 'img/flagPacman.jpg', flipSide: true },
        { x: 8.09, y: 7.5, z: 13.59, rotation: Math.PI * 0.3, image: 'img/flagSonic.jpg', flipSide: true },
        { x: 15.77, y: 7.5, z: 7.09, rotation: Math.PI * 0.4, image: 'img/flagSpace.jpg', flipSide: true },
        { x: 16, y: 7.5, z: 0.01, rotation: Math.PI * 1.8, image: 'img/flagDigger.jpg', flipSide: false },
        { x: 10.95, y: 7.5, z: -5.55, rotation: Math.PI * 1.75, image: 'img/flagMario.jpg', flipSide: false }
    ];
    
    // ×˜×¢×™× ×ª ×˜×§×¡×˜×•×¨×•×ª ×•×™×¦×™×¨×ª ×”××©×™×
    const textureLoader = new THREE.TextureLoader();
    
    // ××¢×‘×¨ ×¢×œ ×›×œ ××—×ª ××”×ª××•× ×•×ª ×‘××¢×¨×š
    imagePositions.forEach((item, index) => {
        textureLoader.load(
            item.image,
            (texture) => {
                // ×—×™×©×•×‘ ×™×—×¡ ×¨×•×—×‘:×’×•×‘×” ×©×œ ×”×ª××•× ×”
                const aspectRatio = texture.image.width / texture.image.height;
                
                // ×’×•×“×œ ×”×ª××•× ×” (×¨×•×—×‘=1.5 ××˜×¨, ×’×•×‘×” ××—×•×©×‘ ×œ×¤×™ ×”×™×—×¡)
                const width = 1.5;
                const height = width / aspectRatio;
                
                // ×™×¦×™×¨×ª ×’×™××•××˜×¨×™×” ×©×œ ×”×ª××•× ×”
                const geometry = new THREE.PlaneGeometry(width, height);
                
                // ×™×¦×™×¨×ª ×—×•××¨ ×¢× ×”×˜×§×¡×˜×•×¨×”
                const material = new THREE.MeshBasicMaterial({
                    map: texture,
                    side: THREE.DoubleSide,
                    transparent: true
                });
                
                // ×™×¦×™×¨×ª ×”××© ×©×œ ×”×ª××•× ×”
                const imageMesh = new THREE.Mesh(geometry, material);
                
                // ××™×§×•× ×”×ª××•× ×” ××¢×œ ×”××›×•× ×”
                imageMesh.position.set(item.x, item.y, item.z);
                
                // ×¡×™×‘×•×‘ ×”×ª××•× ×” ×œ×¤×™ ×¡×™×‘×•×‘ ×”××›×•× ×”
                imageMesh.rotation.y = item.rotation;
                
                // ×× ×¦×¨×™×š ×œ×”×¤×•×š ××ª ×”×¦×“, ×¡×•×‘×‘ ×‘-180 ××¢×œ×•×ª ×¡×‘×™×‘ ×¦×™×¨ Y × ×•×¡×£
                if (item.flipSide) {
                    imageMesh.rotateY(Math.PI);
                }
                
                // ×”×•×¡×¤×ª ×”×ª××•× ×” ×œ×¡×¦× ×”
                scene.add(imageMesh);
                console.log(`Image ${index + 1} added successfully`);
                
                // ××¤×©×¨×•×ª: ×”×•×¡×¤×ª ××¡×’×¨×ª ×œ×ª××•× ×”
                addFrameToImage(imageMesh, width, height, item.flipSide);
            },
            (xhr) => {
                console.log(`Image ${index + 1} loading: ${(xhr.loaded / xhr.total) * 100}% loaded`);
            },
            (error) => {
                console.error(`Error loading image ${index + 1}:`, error);
            }
        );
    });
};

const addGameMachinePortals = () => {
    // ××¢×¨×š ×©×œ ××™×§×•××™× ×”××›×•× ×•×ª
    const machinePositions = [
        { x: -7.34, y: 3, z: 9, rotation: Math.PI * 1.0 },
        { x: 0.75, y: 3, z: 12.40, rotation: Math.PI },
        { x: 5.90, y: 3, z: 12.30, rotation: Math.PI * 1.3 },
        { x: 13.49, y: 3, z: 6.12, rotation: Math.PI * 1.4 },
        { x: 14.37, y: 3, z: 2.27, rotation: Math.PI * 1.8 },
        { x: 8.9, y: 3, z: -3.82, rotation: Math.PI * 1.75 }
    ];
    
    // ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×§×˜×Ÿ ×œ×¤× ×™ ×›×œ ××›×•× ×”
    machinePositions.forEach((machine, index) => {
        // ×—×™×©×•×‘ ×”××™×§×•× ×©×œ ×”×¤×•×¨×˜×œ ×œ×¤×™ ×”×¡×™×‘×•×‘ ×©×œ ×”××›×•× ×”
        // ×”×¤×•×¨×˜×œ ×™×”×™×” ×‘××¨×—×§ 2.0 ××˜×¨ ××”××›×•× ×” ×‘×›×™×•×•×Ÿ ×”×¡×™×‘×•×‘ (×”×’×“×œ×” ×-1.5)
        const portalDistance = 2.0;
        
        // ×—×™×©×•×‘ ×”×–×•×•×™×ª ×‘×”×ª×× ×œ×¡×™×‘×•×‘ ×”××›×•× ×”
        const angle = machine.rotation;
        
        // ×—×™×©×•×‘ ××™×§×•× ×”×¤×•×¨×˜×œ - ×‘×›×™×•×•×Ÿ ×”×¡×™×‘×•×‘ ×©×œ ×”××›×•× ×”
        const portalX = machine.x - Math.sin(angle) * portalDistance;
        const portalZ = machine.z - Math.cos(angle) * portalDistance;
        
        // ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×§×˜×Ÿ ×‘×¡×’× ×•×Ÿ ×“×•××” ×œ×¤×•×¨×˜×œ ×”×¨××©×™ ××‘×œ ×§×˜×Ÿ ×™×•×ª×¨
        createMachinePortalEffect({
            x: portalX,
            y: 1.3, // ×§×¦×ª ×™×•×ª×¨ × ××•×š ××”×¤×•×¨×˜×œ ×”×¨××©×™
            z: portalZ
        }, index + 1); // ×”×¢×‘×¨×ª ××™× ×“×§×¡ ×”××›×•× ×” ×œ×¤×•×¨×˜×œ
    });
};

// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ××¤×§×˜ ×¤×•×¨×˜×œ ×œ××›×•× ×ª ××©×—×§
// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×œ××›×•× ×ª ××©×—×§ ×¢× ×™×•×ª×¨ ×©×§×™×¤×•×ª
// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×™×¦×™×¨×ª ×¤×•×¨×˜×œ ×œ××›×•× ×ª ××©×—×§ ×¢× ×¨×“×™×•×¡ ×’×“×•×œ ×™×•×ª×¨
const createMachinePortalEffect = (position, machineIndex) => {
    // ×¨×“×™×•×¡ ×’×“×•×œ ×™×•×ª×¨ ×œ×¤×•×¨×˜×œ×™× ×©×œ ×”××›×•× ×•×ª
    const portalRadius = 2.5; // ×”×’×“×œ×” ×-1.2 ×œ-2.5
    const particleCount = 200; // ×™×•×ª×¨ ×—×œ×§×™×§×™× ×œ×¤×•×¨×˜×œ ×’×“×•×œ ×™×•×ª×¨
    
    // ×™×¦×™×¨×ª ×’×™××•××˜×¨×™×” ×œ×—×œ×§×™×§×™×
    const particleGeometry = new THREE.BufferGeometry();
    const positions = new Float32Array(particleCount * 3);
    const colors = new Float32Array(particleCount * 3);
    
    // ×”×’×“×¨×ª ×¢×©×Ÿ ×‘××¢×’×œ ×¡×‘×™×‘ × ×§×•×“×ª ×”×¤×•×¨×˜×œ
    for (let i = 0; i < particleCount; i++) {
        // ××™×§×•× ××§×¨××™ ×‘×ª×•×š ×¡×¤×™×¨×”
        const angle = Math.random() * Math.PI * 2;
        const radius = Math.random() * portalRadius;
        const height = Math.random() * 2.0; // ×’×•×‘×” ×’×‘×•×” ×™×•×ª×¨ ×œ×—×œ×§×™×§×™×
        
        // ×”×•×¡×¤×ª ×¨× ×“×•××™×•×ª ×§×˜× ×” ×œ××™×§×•×
        positions[i * 3] = position.x + Math.cos(angle) * radius;
        positions[i * 3 + 1] = position.y + height;
        positions[i * 3 + 2] = position.z + Math.sin(angle) * radius;
        
        // ×¦×‘×¢ ×›×—×•×œ ×‘×”×™×¨ ×¢× ×•×¨×™××¦×™×•×ª ×§×œ×•×ª (×©×•× ×” ××”×¡×’×•×œ ×©×œ ×”×¤×•×¨×˜×œ ×”×¨××©×™)
        colors[i * 3] = 0.1 + Math.random() * 0.2; // ××“×•×
        colors[i * 3 + 1] = 0.7 + Math.random() * 0.3; // ×™×¨×•×§ (×™×•×ª×¨)
        colors[i * 3 + 2] = 0.9 + Math.random() * 0.1; // ×›×—×•×œ (××§×¡×™××œ×™)
    }
    
    particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
    particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    
    // ×™×¦×™×¨×ª ××˜×¨×™××œ ×œ×—×œ×§×™×§×™× - ×¢× ×©×§×™×¤×•×ª ×’×‘×•×”×” ×™×•×ª×¨
    const particleMaterial = new THREE.PointsMaterial({
        size: 0.2, // ×’×•×“×œ ×—×œ×§×™×§×™× ×’×“×•×œ ×™×•×ª×¨
        transparent: true,
        opacity: 0.2,
        vertexColors: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false,
        sizeAttenuation: true
    });
    
    // ×™×¦×™×¨×ª ×”××¢×¨×›×ª ×—×œ×§×™×§×™×
    const portalParticles = new THREE.Points(particleGeometry, particleMaterial);
    scene.add(portalParticles);
    
    // ×”×•×¡×¤×ª ××•×¨ × ×§×•×“×ª×™ ×›×—×•×œ ×‘××–×•×¨ ×”×¤×•×¨×˜×œ - ×—×–×§ ×™×•×ª×¨
    const portalLight = new THREE.PointLight(0x00BFFF, 0.7, 6); // ×”×’×“×œ×ª ×˜×•×•×— ×”××•×¨
    portalLight.position.copy(position);
    portalLight.position.y += 0.5;
    scene.add(portalLight);
    
    // ×”×•×¡×¤×ª ×”×ª××•× ×” ×œ××©×—×§
    addImageToPortal(position, machineIndex, portalRadius);
    
    // ×™×¦×™×¨×ª ××–×”×” ×™×™×—×•×“×™ ×œ×¤×•×¨×˜×œ ×›×“×™ ×©× ×•×›×œ ×œ×–×”×•×ª ××•×ª×• ×‘×‘×“×™×§×ª ×”×ª× ×’×©×•×™×•×ª
    portalParticles.userData = {
        isGamePortal: true,
        machineIndex: machineIndex,
        position: position,
        radius: portalRadius * 0.8 // ×¨×“×™×•×¡ ×’×“×•×œ ×™×•×ª×¨ ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×™×•×ª
    };
    
    // ×”×•×¡×¤×” ×œ××¢×¨×š ×”×’×œ×•×‘×œ×™ ×©×œ ×¤×•×¨×˜×œ×™×
    gameMachinePortals.push({
        particles: portalParticles,
        light: portalLight,
        position: position,
        radius: portalRadius * 1.0, // ×”×’×“×œ×ª ××–×•×¨ ×”×”×ª× ×’×©×•×ª
        machineIndex: machineIndex,
        active: true // ×¤×•×¨×˜×œ ×¤×¢×™×œ ×›×‘×¨×™×¨×ª ××—×“×œ
    });
    
    return portalParticles;
};
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª××•× ×” ×œ×¤×•×¨×˜×œ
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª××•× ×” ×œ×¤×•×¨×˜×œ - ××•×ª×××ª ×œ×¤×•×¨×˜×œ ×’×“×•×œ ×™×•×ª×¨
// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×ª××•× ×” ×œ×¤×•×¨×˜×œ - ××•×ª×××ª ×œ×ª××•× ×•×ª ×§×˜× ×•×ª ×™×•×ª×¨ ×•×§×¨×•×‘×•×ª ×™×•×ª×¨ ×œ×©×—×§×Ÿ
const addImageToPortal = (position, machineIndex, portalRadius) => {
    // ×‘×—×™×¨×ª ×”×ª××•× ×” ×”××ª××™××” ×œ×¤×™ ××¡×¤×¨ ×”××›×•× ×”
    let imagePath;
    switch(machineIndex) {
        case 1:
            imagePath = 'symbols/dave.png';
            break;
        case 2:
            imagePath = 'symbols/pacman.png';
            break;
        case 3:
            imagePath = 'symbols/sonic.png';
            break;
        case 4:
            imagePath = 'symbols/skyroads.png';
            break;
        case 5:
            imagePath = 'symbols/digger.png';
            break;
        case 6:
            imagePath = 'symbols/mario.png';
            break;
        default:
            imagePath = 'symbols/dave.png'; // ×ª××•× ×ª ×‘×¨×™×¨×ª ××—×“×œ
    }
    
    // ×˜×¢×™× ×ª ×”×˜×§×¡×˜×•×¨×” ××”×§×•×‘×¥
    const textureLoader = new THREE.TextureLoader();
    textureLoader.load(
        imagePath, // × ×ª×™×‘ ×œ×ª××•× ×” ×”×¡×¤×¦×™×¤×™×ª
        (texture) => {
            // ×™×¦×™×¨×ª ××™×©×•×¨ ×©×™×¦×™×’ ××ª ×”×ª××•× ×” - ×§×˜×Ÿ ×™×•×ª×¨
            const imageSize = portalRadius * 0.9; // ×”×§×˜× ×” ×-1.4 ×œ-0.9
            
            // ×‘×“×™×§×ª ×™×—×¡ ×”×¨×•×—×‘-×’×•×‘×” ×©×œ ×”×ª××•× ×”
            const aspectRatio = texture.image ? texture.image.width / texture.image.height : 1;
            
            // ×™×¦×™×¨×ª ×’×™××•××˜×¨×™×” ××ª××™××” ×œ×ª××•× ×”
            const geometry = new THREE.PlaneGeometry(
                imageSize, 
                imageSize / aspectRatio
            );
            
            // ×™×¦×™×¨×ª ××˜×¨×™××œ ×¢× ×”×˜×§×¡×˜×•×¨×”
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide,
                depthWrite: false
            });
            
            // ×”×¤×™×›×ª ×”×˜×§×¡×˜×•×¨×” ×©×œ ×¡×•× ×™×§
            if (machineIndex === 3) {
                texture.rotation = Math.PI;
                texture.center.set(0.5, 0.5);
                texture.needsUpdate = true;
            }
            
            // ×™×¦×™×¨×ª ×”××©
            const imageMesh = new THREE.Mesh(geometry, material);
            
            // ××™×§×•× ×”×ª××•× ×” ×‘×ª×•×š ×”×¤×•×¨×˜×œ
            imageMesh.position.copy(position);
            
            // ×”×–×–×ª ×”×ª××•× ×” ×§×“×™××” ×™×•×ª×¨ ×œ×›×™×•×•×Ÿ ×”×©×—×§×Ÿ
            // ×—×™×©×•×‘ ×”×›×™×•×•×Ÿ ××œ ××¨×›×– ×”×¡×¦× ×” (×‘×¢×¨×š ××™×§×•× ×”×©×—×§×Ÿ)
            const centerDirection = new THREE.Vector3(0, 0, 0).sub(position).normalize();
            
            // ×”×–×–×ª ×”×ª××•× ×” ×‘×›×™×•×•×Ÿ ×–×”
            imageMesh.position.add(centerDirection.multiplyScalar(0.5)); // ×”×–×–×” ×§×“×™××” ×‘-0.5 ×™×—×™×“×•×ª
            
            // ×”×–×–×” ×§×˜× ×” ×œ××¢×œ×”
            imageMesh.position.y += 0.3;
            
            // ×¡×™×‘×•×‘ ×”×ª××•× ×” ×›×š ×©×ª××™×“ ×ª×¤× ×” ××œ ×”××¦×œ××”
            imageMesh.userData.machineIndex = machineIndex;
            
            // ×”×•×¡×¤×ª ×× ×™××¦×™×” ×œ×ª××•× ×”
            imageMesh.userData.animationType = machineIndex % 3;
            imageMesh.userData.animationOffset = Math.random() * Math.PI * 2;
            
            // ×”×•×¡×¤×ª ×”×ª××•× ×” ×œ×¡×¦× ×”
            scene.add(imageMesh);
            
            // ×©××™×¨×ª ×”×ª××•× ×” ×‘××¢×¨×š ×”×¤×•×¨×˜×œ×™× ×œ×¦×•×¨×š ×× ×™××¦×™×”
            if (gameMachinePortals[machineIndex - 1]) {
                gameMachinePortals[machineIndex - 1].imageMesh = imageMesh;
            }
        },
        undefined,
        (error) => {
            console.error(`×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª××•× ×” ×œ×¤×•×¨×˜×œ ${machineIndex}:`, error);
        }
    );
};

// ×¢×“×›×•×Ÿ ×¤×•× ×§×¦×™×™×ª ×”×× ×™××¦×™×” ×©×œ ×”×¤×•×¨×˜×œ×™×
const animateGamePortals = () => {
    gameMachinePortals.forEach(portal => {
        if (portal.active) {
            // ×× ×™××¦×™×” ×©×œ ×”×—×œ×§×™×§×™×
            if (portal.particles) {
                const positions = portal.particles.geometry.attributes.position.array;
                
                for (let i = 0; i < positions.length; i += 3) {
                    // ×ª× ×•×¢×” ××§×¨××™×ª ×§×œ×”
                    positions[i] += (Math.random() - 0.5) * 0.025; // ×ª× ×•×¢×” ×¢×“×™× ×” ×™×•×ª×¨
                    positions[i + 1] += Math.random() * 0.025; // ×ª× ×•×¢×” ×§×œ×” ×œ××¢×œ×”
                    positions[i + 2] += (Math.random() - 0.5) * 0.025; // ×ª× ×•×¢×” ×¢×“×™× ×” ×™×•×ª×¨
                    
                    // ×”×—×–×¨ ×—×œ×§×™×§×™× ×©×™×¦××• ×—×–×¨×” ×œ××–×•×¨ ×”×¤×•×¨×˜×œ
                    const dx = positions[i] - portal.position.x;
                    const dz = positions[i + 2] - portal.position.z;
                    const distance = Math.sqrt(dx * dx + dz * dz);
                    
                    if (distance > portal.radius || positions[i + 1] > portal.position.y + 1.5) {
                        // ×× ×”×—×œ×§×™×§ ×™×¦× ××”×’×‘×•×œ×•×ª, ×”×—×–×¨ ××•×ª×• ×œ××™×§×•× ×—×“×© ×‘×ª×•×š ×”×¤×•×¨×˜×œ
                        const angle = Math.random() * Math.PI * 2;
                        const radius = Math.random() * portal.radius * 0.7;
                        
                        positions[i] = portal.position.x + Math.cos(angle) * radius;
                        positions[i + 1] = portal.position.y + Math.random() * 1;
                        positions[i + 2] = portal.position.z + Math.sin(angle) * radius;
                    }
                }
                
                portal.particles.geometry.attributes.position.needsUpdate = true;
            }
            
            // ×× ×™××¦×™×” ×©×œ ××•×¨ - ×©×™× ×•×™ ×¢×•×¦××” ×§×œ×•×ª
            if (portal.light) {
                portal.light.intensity = 0.5 + Math.sin(Date.now() * 0.002) * 0.2; // ××•×¨ ×¢×“×™×Ÿ ×™×•×ª×¨
            }
            
            // ×× ×™××¦×™×” ×©×œ ×”×ª××•× ×” ×‘×¤×•×¨×˜×œ
            if (portal.imageMesh) {
                // ×•×“× ×©×”×ª××•× ×” ×ª××™×“ ××•×¤× ×™×ª ×œ××¦×œ××”
                portal.imageMesh.lookAt(camera.position);
                
                // ×× ×™××¦×™×” × ×•×¡×¤×ª ×œ×¤×™ ×¡×•×’ ×”×× ×™××¦×™×”
                const time = Date.now() * 0.001;
                const offset = portal.imageMesh.userData.animationOffset || 0;
                
                switch (portal.imageMesh.userData.animationType) {
                    case 0: // ×¡×™×‘×•×‘ ×§×œ
                        portal.imageMesh.rotation.z = Math.sin(time + offset) * 0.05; // ×¡×™×‘×•×‘ ×¢×“×™×Ÿ ×™×•×ª×¨
                        break;
                    case 1: // ×ª× ×•×¢×” ×œ××¢×œ×”-×œ××˜×”
                        portal.imageMesh.position.y = portal.position.y + 0.1 + Math.sin(time + offset) * 0.15; // ×ª× ×•×¢×” ×¢×“×™× ×” ×™×•×ª×¨
                        break;
                    case 2: // ×©×™× ×•×™ ×’×•×“×œ ×§×œ
                        const scale = 1 + Math.sin(time + offset) * 0.05; // ×©×™× ×•×™ ×’×•×“×œ ×¢×“×™×Ÿ ×™×•×ª×¨
                        portal.imageMesh.scale.set(scale, scale, scale);
                        break;
                }
                
                // ××¤×§×˜ ×¨×™×—×•×£ - ×©×™× ×•×™ ×§×œ ×‘××•×¤×¡×™×˜×™
                if (portal.imageMesh.material) {
                    portal.imageMesh.material.opacity = 0.6 + Math.sin(time * 2 + offset) * 0.1; // ×©×™× ×•×™×™× ×¢×“×™× ×™× ×™×•×ª×¨
                }
            }
        }
    });
};
// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¨×˜×œ×™ ×”××›×•× ×•×ª
// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×”×ª× ×’×©×•×ª ×¢× ×¤×•×¨×˜×œ×™ ×”××›×•× ×•×ª - ×¢× ×¨×“×™×•×¡ ×‘×“×™×§×” ×’×“×•×œ ×™×•×ª×¨
const checkGamePortalCollisions = (position) => {
    // ×× ×‘××¦×‘ ×”×ª×¢×œ××•×ª ××¤×•×¨×˜×œ×™×, ×”×—×–×¨ false
    if (window.ignorePortals) return false;
    
    for (const portal of gameMachinePortals) {
        if (portal.active) {
            const distanceToPortal = position.distanceTo(new THREE.Vector3(
                portal.position.x,
                portal.position.y,
                portal.position.z
            ));
            
            // ×”×’×“×œ×ª ××–×•×¨ ×”×”×ª× ×’×©×•×ª - ×›×“×™ ×œ×”×§×œ ×¢×œ ×”×›× ×™×¡×” ×œ×¤×•×¨×˜×œ
            if (distanceToPortal < portal.radius * 1.5) { // ×”×›×¤×œ×ª ×”×¨×“×™×•×¡ ×‘-1.5 ×œ×”×’×“×œ×ª ××–×•×¨ ×”×”×ª× ×’×©×•×ª
                // ×›××©×¨ ×”×©×—×§×Ÿ ×§×¨×•×‘ ×œ×¤×•×¨×˜×œ, ×¤×ª×— ××ª ×”××•×“××œ
                openGameModal(portal.machineIndex);
                return true;
            }
        }
    }
    
    return false;
};

// ×™×¦×™×¨×ª ××•×“××œ ×œ××©×—×§
const createGameModal = () => {
    // ×‘×“×™×§×” ×× ×”××•×“××œ ×›×‘×¨ ×§×™×™×
    if (document.getElementById('game-modal')) return;
    
    // ×™×¦×™×¨×ª ××œ×× ×˜ ×”××•×“××œ
    const modal = document.createElement('div');
    modal.id = 'game-modal';
    modal.style.display = 'none';
    modal.style.position = 'fixed';
    modal.style.zIndex = '1000';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.overflow = 'hidden';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    
    // ×™×¦×™×¨×ª ×ª×•×›×Ÿ ×”××•×“××œ
    const modalContent = document.createElement('div');
    modalContent.style.backgroundColor = '#000';
    modalContent.style.margin = '5vh auto';
    modalContent.style.width = '90%';
    modalContent.style.height = '85vh';
    modalContent.style.border = '1px solid #888';
    modalContent.style.borderRadius = '8px';
    modalContent.style.position = 'relative';
    
    // ×›×¤×ª×•×¨ ×¡×’×™×¨×”
    const closeButton = document.createElement('span');
    closeButton.innerHTML = '&times;';
    closeButton.style.color = '#ffffff';
    closeButton.style.float = 'right';
    closeButton.style.fontSize = '28px';
    closeButton.style.fontWeight = 'bold';
    closeButton.style.position = 'absolute';
    closeButton.style.right = '15px';
    closeButton.style.top = '5px';
    closeButton.style.cursor = 'pointer';
    closeButton.style.zIndex = '1001';
    
    // ××™×¨×•×¢ ×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨ ×”×¡×’×™×¨×”
    closeButton.addEventListener('click', closeGameModal);
    
    // ×™×¦×™×¨×ª iframe
    const gameFrame = document.createElement('iframe');
    gameFrame.id = 'game-frame';
    gameFrame.style.width = '100%';
    gameFrame.style.height = '100%';
    gameFrame.style.border = 'none';
    gameFrame.style.borderRadius = '8px';
    
    // ×”×•×¡×¤×ª ×”××œ×× ×˜×™× ×œDOM
    modalContent.appendChild(closeButton);
    modalContent.appendChild(gameFrame);
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // ×¡×’×™×¨×ª ×”××•×“××œ ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×ª×•×›×Ÿ
    modal.addEventListener('click', (event) => {
        if (event.target === modal) closeGameModal();
    });
    closeButton.addEventListener('click', (e) => {
    e.stopPropagation();
    closeGameModal();
});
};

// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×¤×ª×™×—×ª ×”××•×“××œ
// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×¤×ª×™×—×ª ×”××•×“××œ ×¢× ×˜×™×¤×•×œ ×‘××˜×‘×¢×•×ª ×•×©×œ×™×˜×”
const gameSources = {};

// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×¤×ª×™×—×ª ×”××•×“××œ - ×’×¨×¡×” ×¤×©×•×˜×”
// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×¤×ª×™×—×ª ×”××•×“××œ - ×’×¨×¡×” ×¤×©×•×˜×”
// ×¤×•× ×§×¦×™×” ×œ×¤×ª×™×—×ª ×”××•×“××œ - ×¢× ×”×©×”×™×™×ª ×× ×™××¦×™×”
const openGameModal = (machineIndex) => {
    // ×‘×“×™×§×” ×× ×›×‘×¨ ×‘×™×§×¨× ×• ×‘××©×—×§ ×–×”
    if (visitedGames.includes(machineIndex)) {
        // ×™×¦×™×¨×ª ×”×•×“×¢×” ×‘××§×•× ×¤×ª×™×—×ª ×”××•×“××œ
        showGameVisitedMessage(machineIndex);
        return;
    }
    
    // ×‘×“×™×§×” ×× ×™×© ××¡×¤×™×§ ××˜×‘×¢×•×ª (×œ×¤×—×•×ª 5)
    if (playerCoins < 5) {
        alert('××™×Ÿ ××¡×¤×™×§ ××˜×‘×¢×•×ª! ×¦×¨×™×š ×œ×¤×—×•×ª 5 ××˜×‘×¢×•×ª ×›×“×™ ×œ×©×—×§.');
        return;
    }
    
    // ×™×¦×™×¨×ª ×”××•×“××œ ×× ×”×•× ×œ× ×§×™×™×
    createGameModal();
    
    const modal = document.getElementById('game-modal');
    const gameFrame = document.getElementById('game-frame');
    
    // ×”×©×”×™×™×ª ×”×× ×™××¦×™×” ×œ×—×™×¡×›×•×Ÿ ×‘××©××‘×™×
    pauseAnimation();
    
    // ××™×¤×•×¡ ××¦×‘ ×”×ª× ×•×¢×”
    movingForward = false;
    movingBackward = false;
    if (controls) {
        controls.moveForward = false;
        controls.moveBackward = false;
        controls.enabled = false;
    }
    
    // ×¢×¦×™×¨×ª ×”×”×œ×™×›×”
    if (isWalking && walkSound) {
        walkSound.pause();
        isWalking = false;
    }
    
    // ×”×¡×¨×ª ×”×¡××Ÿ ××”××¡×š
    document.getElementById('crosshair').style.display = 'none';
    
    // ×‘×“×™×§×” ×× ×× ×—× ×• ×¤×•×ª×—×™× ××•×ª×” ××›×•× ×” ××—×“×©
    if (modal.currentMachine === machineIndex && gameFrame.src && gameFrame.src !== 'about:blank') {
        // ×× ×–×• ××•×ª×” ××›×•× ×” ×•×›×‘×¨ ×™×© ×ª×•×›×Ÿ ×‘-iframe, ×¤×©×•×˜ × ×¦×™×’ ××ª ×”××•×“××œ ××—×“×©
        console.log(`×¤×ª×™×—×” ××—×“×© ×©×œ ××•×“××œ ×§×™×™× ×œ××›×•× ×” ${machineIndex}`);
        modal.style.display = 'block';
        
        // ××ª×Ÿ ×¤×•×§×•×¡ ×œ-iframe ××•×˜×•××˜×™×ª
        setTimeout(() => {
            gameFrame.focus();
        }, 100);
        
        return;
    }
    
    // ×©××™×¨×ª ×”××›×•× ×” ×”× ×•×›×—×™×ª
    modal.currentMachine = machineIndex;
    
    // ×§×‘×™×¢×ª ××§×•×¨ ×”-iframe ×œ×¤×™ ×¡×•×’ ×”××›×•× ×”
    let gameSource = '';
    switch(machineIndex) {
        case 1:
            gameSource = 'games/dave.html?from=modal';
            break;
        case 2:
            gameSource = 'games/pacman.html?from=modal';
            break;
        case 3:
            gameSource = 'games/sonic.html?from=modal';
            break;
        case 4:
            gameSource = 'games/skyroads.html?from=modal';
            break;
        case 5:
            gameSource = 'games/digger.html?from=modal';
            break;
        case 6:
            gameSource = 'games/mario.html?from=modal';
            break;
        default:
            gameSource = 'games/dave.html?from=modal';
    }
    
    // ×”×¦×’×ª ×”××•×“××œ
    modal.style.display = 'block';
    
    // ×˜×¢×™× ×ª ×”××©×—×§ ×‘-iframe
    gameFrame.src = gameSource;
    
    // ××ª×Ÿ ×¤×•×§×•×¡ ×œ-iframe ××•×˜×•××˜×™×ª ×œ××—×¨ ×˜×¢×™× ×”
    gameFrame.onload = function() {
        gameFrame.focus();
    };
    
    // ×©××™×¨×ª ×”××§×•×¨ ×”× ×•×›×—×™
    gameSources[machineIndex] = gameSource;
    
    console.log(`××•×“××œ × ×¤×ª×— ×œ××›×•× ×” ${machineIndex} ×¢× ××§×•×¨: ${gameSource}`);
    
    // ×”×¤×¢×œ×ª ××™×¨×•×¢ ×¤×ª×™×—×ª ××•×“××œ
    document.dispatchEvent(new Event('modalOpened'));
};
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×” ×›×©×× ×¡×™× ×œ×’×©×ª ×œ××©×—×§ ×©×›×‘×¨ ×‘×™×§×¨×ª ×‘×•
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×” ×›×©×× ×¡×™× ×œ×’×©×ª ×œ××©×—×§ ×©×›×‘×¨ ×‘×™×§×¨×ª ×‘×•
// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×•×“×¢×” ×›×©×× ×¡×™× ×œ×’×©×ª ×œ××©×—×§ ×©×›×‘×¨ ×‘×™×§×¨×ª ×‘×•
const showGameVisitedMessage = (machineIndex) => {
    // ×™×¦×™×¨×ª ×”××•×“××œ ×× ×”×•× ×œ× ×§×™×™×
    createGameModal();
    
    const modal = document.getElementById('game-modal');
    const gameFrame = document.getElementById('game-frame');
    
    // ×§×‘×™×¢×ª ×”×©×œ×™×˜×” ×œ××¦×‘ ×œ× ×¤×¢×™×œ ×‘×¢×ª ×¤×ª×™×—×ª ×”××•×“××œ
    if (controls) controls.enabled = false;
    
    // ×¢×¦×™×¨×ª ×”×”×œ×™×›×”
    if (isWalking && walkSound) {
        walkSound.pause();
        isWalking = false;
    }
    
    // ×”×¡×¨×ª ×”×¡××Ÿ ××”××¡×š
    document.getElementById('crosshair').style.display = 'none';
    
    // ×§×‘×™×¢×ª ×ª×•×›×Ÿ ×”-iframe ×œ×”×™×•×ª ×“×£ ×”×”×•×“×¢×”
    modal.style.display = 'block';
    gameFrame.src = 'games/visited.html';
    
    // ×©××™×¨×ª ×”××›×•× ×” ×”× ×•×›×—×™×ª ×‘××•×“××œ (×›×“×™ ×œ×“×¢×ª ××™×–×” ××©×—×§ × ×™×¡×™× ×• ×œ×’×©×ª ××œ×™×•)
    modal.currentMachine = machineIndex;
};
// ×”×•×¡×¤×ª ××™×¨×•×¢ ×©×™×—×–×™×¨ ××ª ×”×¤×•×§×•×¡ ×œ-iframe ×›×©×”××©×ª××© ×—×•×–×¨ ×œ×—×œ×•×Ÿ
window.addEventListener('focus', () => {
    const modal = document.getElementById('game-modal');
    const gameFrame = document.getElementById('game-frame');
    
    if (modal && modal.style.display === 'block' && gameFrame) {
        setTimeout(() => {
            gameFrame.focus();
        }, 100);
    }
});
// ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×”××•×“××œ - ×’×¨×¡×” ×¤×©×•×˜×”
// ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×”××•×“××œ - ×¢× ×”×—×–×¨×” ×œ××™×§×•× ×§×‘×•×¢
// ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×”××•×“××œ - ×¢× ×—×™×“×•×© ×”×× ×™××¦×™×”
// ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ×”××•×“××œ - ×©×•××¨×ª ×¢×œ ×”××©×—×§ ××‘×œ ××•× ×¢×ª ×‘×¢×™×•×ª
const closeGameModal = () => {
    // ×”×“×¤×¡ ×œ××¡×•×£ ×©×”××•×“××œ × ×¡×’×¨
    console.log('×¡×•×’×¨ ××•×“××œ, ××©×”×” ×‘×“×™×§×ª ×¤×•×¨×˜×œ×™×...');
    
    // ××™×“ ×‘×ª×—×™×œ×ª ×”×¤×•× ×§×¦×™×”, ×œ×¤× ×™ ×›×œ ×“×‘×¨ ××—×¨
    window.ignorePortals = true;
    
    const modal = document.getElementById('game-modal');
    
    if (!modal) return;
    
    // ×©××•×¨ ××ª ×”××›×•× ×” ×”× ×•×›×—×™×ª (×œ×¦×•×¨×š ×œ×•×’ ×‘×œ×‘×“)
    if (modal.currentMachine) {
        console.log(`×”××•×“××œ ×”×•×¡×ª×¨ ×¢×‘×•×¨ ××›×•× ×” ${modal.currentMachine}`);
    }
    
    // ×”×¡×ª×¨×ª ×”××•×“××œ ×‘××§×•× × ×™×§×•×™ ×”-iframe - ×©×™××•×¨ ××¦×‘ ×”××©×—×§
    modal.style.display = 'none';
    
    // ×—×™×“×•×© ×”×× ×™××¦×™×”
    resumeAnimation();
    
    // ×”×—×–×¨×ª ×”×©×—×§×Ÿ ×œ××™×§×•× ×”×§×‘×•×¢
    camera.position.set(-3.11, 2.20, -3.43);
    
    // ××™×¤×•×¡ ××©×ª× ×™ ×”×ª× ×•×¢×”
    isWalking = false;
    movingForward = false;
    movingBackward = false;
    if (walkSound) walkSound.pause();
    
    // ×•×™×“×•× ×©×”××§×©×™× ×œ× "×ª×§×•×¢×™×"
    if (controls) {
        controls.moveForward = false;
        controls.moveBackward = false;
        controls.moveLeft = false;
        controls.moveRight = false;
        controls.update(0);
    }
    
    // ×¤×¡×§ ×–××Ÿ ×§×¦×¨ ×œ×¤× ×™ ×”×—×–×¨×ª ×©×œ×™×˜×” ×œ××©×ª××©
    setTimeout(() => {
        // ×”×—×–×¨×ª ×”×©×œ×™×˜×” ×•×”×¡××Ÿ
        if (controls) controls.enabled = true;
        document.getElementById('crosshair').style.display = 'block';
    }, 100);
    
    // ×”×¤×¢×œ ×“×’×œ ×”×ª×¢×œ××•×ª ××¤×•×¨×˜×œ×™× ×œ××©×š ×–××Ÿ ××¨×•×š ××¡×¤×™×§
    // ×›×“×™ ×œ×× ×•×¢ ×›× ×™×¡×” ×—×•×–×¨×ª ××™×™×“×™×ª ×œ××•×ª×• ×¤×•×¨×˜×œ
    setTimeout(() => {
        console.log('×–××Ÿ ×¦×™× ×•×Ÿ ×”×¡×ª×™×™×, ××—×“×© ×‘×“×™×§×ª ×¤×•×¨×˜×œ×™×');
        window.ignorePortals = false;
    }, 5000); // 5 ×©× ×™×•×ª ×¦×™× ×•×Ÿ (×–××Ÿ ××¨×•×š ×™×—×¡×™×ª)
    
    // ×”×¤×¢×œ×ª ××™×¨×•×¢ ×¡×’×™×¨×ª ××•×“××œ ×œ×˜×™×¤×•×œ ×‘××•×–×™×§×”
    document.dispatchEvent(new Event('modalClosed'));
};
// ×¢×“×›×•×Ÿ dave.html - ×”×•×¡×£ ×§×•×“ ×–×” ×œ×§×•×‘×¥ ×”××©×—×§ 
// (×©×™× ×‘×¡×§×¨×™×¤×˜ ×”×¨××©×™ ×©×œ dave.html)
/*
// ×‘×“×™×§×” ×× ×”××©×—×§ ×¨×¥ ×‘×ª×•×š iframe/××•×“××œ
const isInModal = window.location.search.includes('from=modal');

// ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª ×”×•×“×¢×•×ª ×œ×”×•×¨×” (××¡×’×¨×ª ×”××ª×¨ ×”×¨××©×™×ª)
function sendMessageToParent(action, data) {
    if (isInModal && window.parent) {
        window.parent.postMessage({
            type: 'gameEvent',
            action: action,
            ...data
        }, '*');
    }
}

// ×œ×“×•×’××”, ×›×©××›× ×™×¡×™× ××˜×‘×¢:
function insertCoin() {
    // ×”×œ×•×’×™×§×” ×”×¨×’×™×œ×” ×©×œ ×”×•×¡×¤×ª ××˜×‘×¢
    coins++;
    updateCoinsDisplay();
    
    // ×©×œ×— ×”×•×“×¢×” ×œ×”×•×¨×”
    sendMessageToParent('coinInserted', { coins: coins });
}

// ×’× ×›×©×”××©×—×§ × ×’××¨, ××¤×©×¨ ×œ×”×•×“×™×¢ ×œ×”×•×¨×”
function gameOver() {
    // ×”×œ×•×’×™×§×” ×”×¨×’×™×œ×” ×©×œ ×¡×™×•× ××©×—×§
    
    // ×©×œ×— ×”×•×“×¢×” ×œ×”×•×¨×”
    sendMessageToParent('gameOver', { score: currentScore });
}
*/


// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ××¡×’×¨×ª ×œ×ª××•× ×” - ×¢×“×›×•×Ÿ ×›×“×™ ×œ×ª××•×š ×‘×¡×™×‘×•×‘ ×©×œ flipSide
const addFrameToImage = (imageMesh, width, height, flipSide) => {
    // ×™×¦×™×¨×ª ×’×™××•××˜×¨×™×” ××¢×˜ ×’×“×•×œ×” ×™×•×ª×¨ ××”×ª××•× ×”
    const frameWidth = width + 0.1;
    const frameHeight = height + 0.1;
    const frameGeometry = new THREE.PlaneGeometry(frameWidth, frameHeight);
    
    // ×—×•××¨ ×œ××¡×’×¨×ª - ××¤×©×¨ ×œ×©× ×•×ª ××ª ×”×¦×‘×¢
    const frameMaterial = new THREE.MeshBasicMaterial({
        color: 0x111111,  // ×¦×‘×¢ ×©×—×•×¨ ×œ××¡×’×¨×ª
        side: THREE.DoubleSide
    });
    
    // ×™×¦×™×¨×ª ×”××© ×©×œ ×”××¡×’×¨×ª
    const frameMesh = new THREE.Mesh(frameGeometry, frameMaterial);
    
    // ××™×§×•× ×”××¡×’×¨×ª ××¢×˜ ×××—×•×¨×™ ×”×ª××•× ×”
    frameMesh.position.copy(imageMesh.position);
    
    // ×”×ª×××ª ×”××™×§×•× ×©×œ ×”××¡×’×¨×ª ×œ×¤×™ ×”×¡×™×‘×•×‘ ×©×œ ×”×ª××•× ×”
    if (flipSide) {
        frameMesh.position.z += 0.01; // ××¢×˜ ×œ×¤× ×™ ×”×ª××•× ×” ×× ×”×™× ××¡×•×‘×‘×ª
    } else {
        frameMesh.position.z -= 0.01; // ××¢×˜ ×××—×•×¨×™ ×”×ª××•× ×” ×× ×”×™× ×œ× ××¡×•×‘×‘×ª
    }
    
    // ×”×¢×ª×§×ª ×”×¡×™×‘×•×‘ ×©×œ ×”×ª××•× ×”
    frameMesh.rotation.copy(imageMesh.rotation);
    
    // ×”×•×¡×¤×ª ×”××¡×’×¨×ª ×œ×¡×¦× ×”
    scene.add(frameMesh);
};
        // ×¤×•× ×§×¦×™×™×ª ×× ×™××¦×™×”
// ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×©×œ×™×˜×” ×‘×× ×™××¦×™×” - ×”×•×¡×£ ×‘×ª×—×™×œ×ª ×”×§×•×“ ×”×¨××©×™
let animationActive = true;
let animationFrameId = null;

// ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×× ×™××¦×™×”
const animate = () => {
    // ×‘×“×™×§×” ×× ×”×× ×™××¦×™×” ×¤×¢×™×œ×”
    if (!animationActive) return;
    
    // ×©××™×¨×ª ×”-ID ×©×œ ×¤×¨×™×™× ×”×× ×™××¦×™×” ×œ×‘×™×˜×•×œ ×× × ×“×¨×©
    animationFrameId = requestAnimationFrame(animate);
    
    if (isLoaded) {
        const delta = clock.getDelta();
        
        if (controls) {
            // ×‘×“×™×§×” ×©×”××•×“××œ ×œ× ×¤×ª×•×— ×œ×¤× ×™ ×¢×“×›×•×Ÿ ×”××¦×œ××”
            const modalOpen = document.getElementById('game-modal')?.style.display === 'block';
            
            if (!modalOpen) {
                // ×©××™×¨×ª ×”××™×§×•× ×”×§×•×“× ×œ×¤× ×™ ×”×¢×“×›×•×Ÿ
                const previousPosition = camera.position.clone();
                
                // ×¢×“×›×•×Ÿ ×”×©×œ×™×˜×”
                controls.update(delta);
                
                // ×©××™×¨×ª ×’×•×‘×” ×§×‘×•×¢ ××¢×œ ×”×¨×¦×¤×”
                camera.position.y = PLAYER_HEIGHT;
                
                // ×‘×“×™×§×” ×× ×”××™×§×•× ×”×—×“×© ×”×•× ×‘×ª×•×š ×”×’×‘×•×œ×•×ª
                if (!isPositionInBounds(camera.position)) {
                    // ×× ×”××™×§×•× ×”×—×“×© ×”×•× ××—×•×¥ ×œ×’×‘×•×œ×•×ª, ×—×–×•×¨ ×œ××™×§×•× ×”×§×•×“×
                    camera.position.copy(previousPosition);
                }
                
                // ×‘×“×™×§×” ×× ×”×’×¢× ×• ×œ×¤×•×¨×˜×œ ×”×¨××©×™
                const atMainPortal = checkCustomLocationPoints(camera.position);
                
                // ×‘×“×™×§×” ×× ×”×’×¢× ×• ×œ×¤×•×¨×˜×œ ×©×œ ××›×•× ×ª ××©×—×§ (×¨×§ ×× ×œ× ×”×’×¢× ×• ×œ×¤×•×¨×˜×œ ×”×¨××©×™)
                if (!atMainPortal) {
                    checkGamePortalCollisions(camera.position);
                }
                
                // ×”×¦×’×ª ×”××™×§×•× ×¢×œ ×”××¡×š
                if (!window.positionDisplay) {
                    window.positionDisplay = document.createElement('div');
                    window.positionDisplay.style.position = 'absolute';
                    window.positionDisplay.style.bottom = '10px';
                    window.positionDisplay.style.left = '10px';
                    window.positionDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    window.positionDisplay.style.color = 'white';
                    window.positionDisplay.style.padding = '5px';
                    window.positionDisplay.style.fontFamily = 'monospace';
                    window.positionDisplay.style.fontSize = '14px';
                    window.positionDisplay.style.borderRadius = '3px';
                    window.positionDisplay.style.zIndex = '1000';
                    document.body.appendChild(window.positionDisplay);
                }
                window.positionDisplay.textContent = 
                    `××™×§×•× ×©×—×§×Ÿ: X: ${camera.position.x.toFixed(2)}, Y: ${camera.position.y.toFixed(2)}, Z: ${camera.position.z.toFixed(2)}`;
            }
        }
        
        // ×× ×™××¦×™×” ×œ×¤×•×¨×˜×œ ×”×¨××©×™
        animatePortal();
        
        // ×× ×™××¦×™×” ×œ×¤×•×¨×˜×œ×™× ×©×œ ×”××›×•× ×•×ª
        animateGamePortals();
    }
    
    renderer.render(scene, camera);
};

// ×¤×•× ×§×¦×™×” ×œ×”×©×”×™×™×ª ×”×× ×™××¦×™×”
const pauseAnimation = () => {
    animationActive = false;
    if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
        animationFrameId = null;
    }
    console.log('×”×× ×™××¦×™×” ×”×•×©×”×ª×”');
};

// ×¤×•× ×§×¦×™×” ×œ×—×™×“×•×© ×”×× ×™××¦×™×”
const resumeAnimation = () => {
    if (!animationActive) {
        animationActive = true;
        animate(); // ××¤×¢×™×œ ××—×“×© ××ª ×œ×•×œ××ª ×”×× ×™××¦×™×”
        console.log('×”×× ×™××¦×™×” ×—×•×“×©×”');
    }
};
        
        // ×”×¤×¢×œ×ª ×”××ª×—×•×œ ×›×©×”×“×£ × ×˜×¢×Ÿ
        window.addEventListener('load', init);

        // ×¤×•× ×§×¦×™×” ×œ× ×™×’×•×Ÿ ××•×–×™×§×ª ×¨×§×¢ ×¨× ×“×•××œ×™×ª
// ×¤×•× ×§×¦×™×” ×œ× ×™×’×•×Ÿ ××•×–×™×§×ª ×¨×§×¢ ×¢× ×”×—×œ×¤×ª ×©×™×¨×™× ××•×˜×•××˜×™×ª
const setupBackgroundMusic = () => {
    // ××¢×¨×š ×©×œ ×©××•×ª ×§×‘×¦×™ ×”×©×™×¨×™×
    const songs = [
        'audio/1.mp3',
        'audio/2.mp3',
        'audio/3.mp3',
        'audio/4.mp3'
    ];
    
    let currentSongIndex = 0;
    let isPlaying = false;
    
    // ×¤×•× ×§×¦×™×” ×œ×”×¤×¢×œ×ª ×©×™×¨ ×œ×¤×™ ××™× ×“×§×¡
    const playSong = (index) => {
        // ×•×“× ×©×”××™× ×“×§×¡ ×‘×˜×•×•×— ×”×ª×§×™×Ÿ
        currentSongIndex = index % songs.length;
        
        console.log(`×× ×’×Ÿ ×©×™×¨ ×¨×§×¢: ${songs[currentSongIndex]}`);
        
        // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×¡××•× ×“ ×¢× ×”×¡×¤×¨×™×™×” Howler
        const backgroundMusic = new Howl({
            src: [songs[currentSongIndex]],
            volume: 0.5,         // ×¢×•×¦××ª ×©××¢ ×‘×™× ×•× ×™×ª
            autoplay: true,      // × ×™×’×•×Ÿ ××•×˜×•××˜×™
            loop: false,         // ×œ×œ× ×œ×•×¤ ×œ×©×™×¨ ×‘×•×“×“
            onend: () => {
                // ×›×©×”×©×™×¨ ××¡×ª×™×™×, ×”×¤×¢×œ ××ª ×”×©×™×¨ ×”×‘×
                playNextSong();
            }
        });
        
        // ×©××™×¨×ª ×”××•×‘×™×™×§×˜ ×‘×—×œ×•×Ÿ ×”×’×œ×•×‘×œ×™ ×›×“×™ ×©× ×•×›×œ ×œ×’×©×ª ××œ×™×• ××›×œ ××§×•×
        window.backgroundMusic = backgroundMusic;
        isPlaying = true;
        
        // ×¢×“×›×•×Ÿ ××™×™×§×•×Ÿ ×›×¤×ª×•×¨ ×”××•×–×™×§×”
        updateMusicButtonIcon();
    };
    
    // ×¤×•× ×§×¦×™×” ×œ×”×¤×¢×œ×ª ×”×©×™×¨ ×”×‘×
    const playNextSong = () => {
        // ×‘×“×™×§×” ×©×”××•×‘×™×™×§×˜ ×”×§×•×“× × ×¢×¦×¨ ×•× ×•×§×”
        if (window.backgroundMusic) {
            window.backgroundMusic.unload();
        }
        
        // ×”×¤×¢×œ×ª ×”×©×™×¨ ×”×‘× ×‘×¨×©×™××”
        playSong(currentSongIndex + 1);
    };
    
    // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ××™×™×§×•×Ÿ ×›×¤×ª×•×¨ ×”××•×–×™×§×”
    const updateMusicButtonIcon = () => {
        const musicButton = document.getElementById('music-control');
        if (!musicButton) return;
        
        if (window.backgroundMusic && window.backgroundMusic.volume() > 0) {
            musicButton.innerHTML = 'ğŸ”ˆ';
        } else {
            musicButton.innerHTML = 'ğŸ”‡';
        }
    };
    
    // ×”×¤×¢×œ×ª ×”×©×™×¨ ×”×¨××©×•×Ÿ
    playSong(Math.floor(Math.random() * songs.length)); // ×”×ª×—×œ×” ×‘×©×™×¨ ××§×¨××™
    
    // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×©×œ×™×˜×” ×‘××•×–×™×§×”
    addMusicControls();
    
    // ×××–×™× ×™× ×œ××™×¨×•×¢×™× ×©×œ ××•×“××œ
    document.addEventListener('modalOpened', () => {
        if (window.backgroundMusic) {
            window.backgroundMusic.volume(0.2); // ×”× ××›×ª ×¢×•×¦××ª ×”×©××¢
            updateMusicButtonIcon();
        }
    });
    
    document.addEventListener('modalClosed', () => {
        if (window.backgroundMusic) {
            window.backgroundMusic.volume(0.5); // ×”×—×–×¨×ª ×¢×•×¦××ª ×”×©××¢
            updateMusicButtonIcon();
        }
    });
    
    // ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×•×ª ×©×œ×™×˜×” ×’×œ×•×‘×œ×™×•×ª ×©×™×”×™×• ×–××™× ×•×ª ××›×œ ××§×•×
    window.musicControls = {
        playNextSong,
        pauseMusic: () => {
            if (window.backgroundMusic) {
                window.backgroundMusic.pause();
                isPlaying = false;
                updateMusicButtonIcon();
            }
        },
        resumeMusic: () => {
            if (window.backgroundMusic) {
                window.backgroundMusic.play();
                isPlaying = true;
                updateMusicButtonIcon();
            }
        },
        toggleMusic: () => {
            if (window.backgroundMusic) {
                if (isPlaying) {
                    window.backgroundMusic.pause();
                    isPlaying = false;
                } else {
                    window.backgroundMusic.play();
                    isPlaying = true;
                }
                updateMusicButtonIcon();
            }
        }
    };
};

// ×¤×•× ×§×¦×™×” ××¢×•×“×›× ×ª ×œ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×©×œ×™×˜×” ×‘××•×–×™×§×”
const addMusicControls = () => {
    // ×™×¦×™×¨×ª ×›×¤×ª×•×¨ ×”×©×ª×§×”/× ×™×’×•×Ÿ
    const musicButton = document.createElement('button');
    musicButton.id = 'music-control';
    musicButton.innerHTML = 'ğŸ”ˆ';
    musicButton.title = '×”×©×ª×§/×”×¤×¢×œ ××•×–×™×§×”';
    
    // ×¢×™×¦×•×‘ ×”×›×¤×ª×•×¨
    musicButton.style.position = 'fixed';
    musicButton.style.top = '10px';
    musicButton.style.left = '10px';
    musicButton.style.zIndex = '100';
    musicButton.style.background = 'rgba(0, 0, 0, 0.5)';
    musicButton.style.color = 'white';
    musicButton.style.border = 'none';
    musicButton.style.borderRadius = '50%';
    musicButton.style.width = '40px';
    musicButton.style.height = '40px';
    musicButton.style.fontSize = '20px';
    musicButton.style.cursor = 'pointer';
    musicButton.style.display = 'flex';
    musicButton.style.justifyContent = 'center';
    musicButton.style.alignItems = 'center';
    
    // ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×—×™×¦×”
    musicButton.addEventListener('click', () => {
        if (window.backgroundMusic) {
            // ×‘×“×™×§×” ×× ×”××•×–×™×§×” ××•×©×ª×§×ª
            if (window.backgroundMusic.volume() > 0) {
                // ×”×©×ª×§×”
                window.backgroundMusic.volume(0);
                musicButton.innerHTML = 'ğŸ”‡';
            } else {
                // ×”×¤×¢×œ×” ××—×“×©
                window.backgroundMusic.volume(0.5);
                musicButton.innerHTML = 'ğŸ”ˆ';
            }
        }
    });
    
    // ×™×¦×™×¨×ª ×›×¤×ª×•×¨ "×©×™×¨ ×”×‘×"
    const nextSongButton = document.createElement('button');
    nextSongButton.id = 'next-song';
    nextSongButton.innerHTML = 'â­ï¸';
    nextSongButton.title = '×©×™×¨ ×”×‘×';
    
    // ×¢×™×¦×•×‘ ×›×¤×ª×•×¨ ×”×©×™×¨ ×”×‘×
    nextSongButton.style.position = 'fixed';
    nextSongButton.style.top = '10px';
    nextSongButton.style.left = '60px';
    nextSongButton.style.zIndex = '100';
    nextSongButton.style.background = 'rgba(0, 0, 0, 0.5)';
    nextSongButton.style.color = 'white';
    nextSongButton.style.border = 'none';
    nextSongButton.style.borderRadius = '50%';
    nextSongButton.style.width = '40px';
    nextSongButton.style.height = '40px';
    nextSongButton.style.fontSize = '16px';
    nextSongButton.style.cursor = 'pointer';
    nextSongButton.style.display = 'flex';
    nextSongButton.style.justifyContent = 'center';
    nextSongButton.style.alignItems = 'center';
    
    // ×”×•×¡×¤×ª ××™×¨×•×¢ ×œ×—×™×¦×” ×œ×›×¤×ª×•×¨ ×”×©×™×¨ ×”×‘×
    nextSongButton.addEventListener('click', () => {
        if (window.musicControls) {
            window.musicControls.playNextSong();
        }
    });
    
    // ×”×•×¡×¤×ª ×”×›×¤×ª×•×¨×™× ×œ×“×£
    document.body.appendChild(musicButton);
    document.body.appendChild(nextSongButton);
};
window.addEventListener('message', function(event) {
    // ×œ×¦×¨×›×™ ×“×™×‘×•×’
    console.log('×”×ª×§×‘×œ×” ×”×•×“×¢×” ××”-iframe:', event.data);
    
    // ×‘×“×™×§×ª ×¡×•×’ ×”×”×•×“×¢×”
    if (event.data.action === 'closeIframe') {
        // ×¡×’×™×¨×ª ×”-iframe ×›×©×œ×•×—×¦×™× ×¢×œ ×›×¤×ª×•×¨ ×”×™×¦×™××”
        closeGameModal(); // ×¤×•× ×§×¦×™×” ×–×• ×ª×—×–×™×¨ ××ª ×”×©×—×§×Ÿ ×œ××™×§×•× ×”×§×‘×•×¢
    }
    else if (event.data.action === 'gameOver') {
        // ×”×•×¨×“×ª 5 ××˜×‘×¢×•×ª ×‘×¡×™×•× ×”××©×—×§
        spendCoin();
        
        console.log('×”××©×—×§ × ×’××¨:', event.data.message);
        console.log('× ×©××¨×•', playerCoins, '××˜×‘×¢×•×ª');
        
        // ×”×•×¡×¤×ª ×”××©×—×§ ×”× ×•×›×—×™ ×œ××¢×¨×š ×”××©×—×§×™× ×©×‘×™×§×¨×ª ×‘×”×
        const modal = document.getElementById('game-modal');
        if (modal && modal.currentMachine && !visitedGames.includes(modal.currentMachine)) {
            visitedGames.push(modal.currentMachine);
            console.log('××©×—×§×™× ×©×‘×™×§×¨×ª ×‘×”×:', visitedGames);
        }
    }
});

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×”×ª×¨××”
const showNotification = (message) => {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.right = '20px';
    notification.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    notification.style.color = 'white';
    notification.style.padding = '10px 20px';
    notification.style.borderRadius = '5px';
    notification.style.zIndex = '1000';
    notification.style.direction = 'rtl';
    notification.style.fontFamily = 'Arial, sans-serif';
    
    document.body.appendChild(notification);
    
    // ×”×¡×¨×ª ×”×”×ª×¨××” ××—×¨×™ 3 ×©× ×™×•×ª
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            notification.remove();
        }, 500);
    }, 3000);
};

const isPositionInBounds = (position) => {
    return (
        position.x >= WORLD_BOUNDS.minX &&
        position.x <= WORLD_BOUNDS.maxX &&
        position.z >= WORLD_BOUNDS.minZ &&
        position.z <= WORLD_BOUNDS.maxZ
    );
};
    </script>
</body>
</html>